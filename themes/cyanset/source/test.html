<body>
    
</body>
<script src="https://registry.npmmirror.com/@chenyfan/cache-db/0.0.4/files/index.js"></script>
<script src="https://registry.npmmirror.com/notyf/3.10.0/files/notyf.min.js"></script>
<script>
    window.notyf = new Notyf({
        duration: 3000,
        position: {
            x: 'right',
            y: 'bottom'
        },
        ripple: true,
        dismissible: true
    });
    (async () => {
        window.db = new CacheDB('CyanAcc');
        if (await db.read('needInstall') === 'never') {
            console.log('CyanAcc已禁用')
            return;
        }
        if ('serviceWorker' in navigator) {
            if (await db.read('install_time') === null ||
                new Date().getTime() > Number(await db.read('install_time')) + 1000 * 60 * 60 * 4) {
                await db.write('install_time', new Date().getTime())
                await db.write('needInstall', 'true')
            }
            if (await db.read('needInstall') === 'true') {
                navigator.serviceWorker.register(`/CyanAcc.js?time=${new Date().getTime()}`)
                    .then(async reg => {
                        const CyanAcc_Checker = setInterval(() => {
                            fetch('/CyanAcc/api', {
                                method: 'POST',
                                body: JSON.stringify({
                                    action: 'PING'
                                })
                            })
                                .then(res => res.text())
                                .then(async res => {
                                    if (res === "PONG") {
                                        notyf.success('CyanAcc安装/更新成功！')
                                        clearInterval(CyanAcc_Checker)
                                        await db.write('needInstall', 'false')
                                    }
                                })
                        }, 1000);
                    }).catch(async err => {
                        notyf.error({
                            message: `CyanAcc安装失败！</br>将不会再尝试启动CyanAcc</br>请点击右上角设置手动安装</br>详细信息请查看控制台`,
                            duration: 10000
                        })
                        console.error(err)
                        await db.write('needInstall', 'never')
                    })
            } else {
                console.log('CyanAcc暂时无需更新')
            }
        } else {
            if (location.protocol !== 'https:') notyf.error('请使用HTTPS协议以启用CyanAcc')
            else {
                notyf.error('您的浏览器不支持或被广告插件禁用ServiceWorker</br>已直接禁用CyanAcc')
                await db.write('needInstall', 'never')
            }
        }
    })();
</script>