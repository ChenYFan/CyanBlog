(()=>{"use strict";self.CacheDB=function(e,t,n){this.config=n||{auto:0},this.config.auto=this.config.auto||0,this.namespace=e||"CacheDBDefaultNameSpace",this.prefix=t||"CacheDBDefaultPrefix",this.has=async function(e){return new Promise((t,n)=>{caches.open(this.namespace).then(n=>{n.match(new Request(`https://${this.prefix}/${encodeURIComponent(e)}`)).then(e=>t(!!e))}).catch(e=>{console.error("CacheDB Has Erorr:"+e),n(!1)})})},this.read=async function(e,t){return(t=t||{}).type=t.type||(this.config.auto?"auto":"text"),await this.has(e)?new Promise((n,i)=>{caches.open(this.namespace).then(i=>{i.match(new Request(`https://${this.prefix}/${encodeURIComponent(e)}`)).then(async e=>{if("auto"===t.type)switch(e.headers.get("Content-Type")){case"application/json":t.type="json";break;case"application/octet-stream":t.type="arrayBuffer";break;case"application/octet-stream":t.type="blob";break;case"text/number":t.type="number";break;case"text/boolean":t.type="boolean";break;default:t.type="text"}switch(t.type){case"number":return void n(Number(await e.text()));case"json":return void n(e.json());case"arrayBuffer":return void n(e.arrayBuffer());case"blob":return void n(e.blob());case"text":return void n(e.text());case"boolean":return void n(1==await e.text());default:return void n(e.body)}})}).catch(e=>{console.error("CacheDB Read Erorr:"+e),i(null)})}):t.default?(await this.write(e,t.default,t),t.default):(console.error("CacheDB Read Erorr: Key not found"),null)},this.write=async function(e,t,n){var i;switch((n=n||{}).type=n.type||(this.config.auto?"auto":"text"),"auto"===n.type&&(n.type="object"==typeof(i=t)&&null!==i&&i.constructor===Object||Array.isArray(i)?"json":typeof t),n.type){case"json":n.content_type="application/json",t=JSON.stringify(t);break;case"arrayBuffer":case"blob":n.content_type="application/octet-stream";break;case"number":n.content_type="text/number",t=t.toString();break;case"boolean":n.content_type="text/boolean",t=t?1:0}return new Promise((i,r)=>{caches.open(this.namespace).then(r=>{r.put(new Request(`https://${this.prefix}/${encodeURIComponent(e)}`),new Response(t,{headers:{"Content-Type":n.content_type}})).then(i(1))}).catch(e=>{console.error("CacheDB Write Erorr:"+e),r(0)})})},this.delete=async function(e){return new Promise((t,n)=>{caches.open(this.namespace).then(n=>{n.delete(new Request(`https://${this.prefix}/${encodeURIComponent(e)}`)).then(t(!0))}).catch(e=>{console.error("CacheDB Delete Erorr:"+e),n(!1)})})},this.list=async function(){return new Promise((e,t)=>{caches.open(this.namespace).then(t=>{t.keys().then(t=>{e(t.map(e=>decodeURIComponent(e.url.split("/").pop())))})}).catch(e=>{console.error("CacheDB List Erorr:"+e),t([])})})},this.all=async function(){const e={};return new Promise(async(t,n)=>{this.list().then(async n=>{await Promise.all(n.map(async t=>{e[t]=await this.read(t)})),t(e)}).catch(e=>{console.error("CacheDB All Erorr:"+e),n([])})})},this.clear=async function(){return new Promise((e,t)=>{this.list().then(t=>{t.forEach(e=>{this.delete(e)}),e(!0)}).catch(e=>{console.error("CacheDB Clear Erorr:"+e),t(!1)})})},this.destroy=async function(){return new Promise((e,t)=>{this.clear().then(()=>{caches.delete(this.namespace).then(e(!0))}).catch(e=>{console.error("CacheDB Destroy Erorr:"+e),t(!1)})})}};const e={TarReader:class{constructor(){this.fileInfo=[]}readFile(e){return new Promise((t,n)=>{let i=new FileReader;i.onload=e=>{this.buffer=e.target.result,this.fileInfo=[],this._readFileInfo(),t(this.fileInfo)},i.readAsArrayBuffer(e)})}readArrayBuffer(e){return this.buffer=e,this.fileInfo=[],this._readFileInfo(),this.fileInfo}_readFileInfo(){this.fileInfo=[];let e=0,t=0,n="",i=null;for(;e<this.buffer.byteLength-512&&(n=this._readFileName(e),0!=n.length);)i=this._readFileType(e),t=this._readFileSize(e),this.fileInfo.push({name:n,type:i,size:t,header_offset:e}),e+=512+512*Math.trunc(t/512),t%512&&(e+=512)}getFileInfo(){return this.fileInfo}_readString(e,t){let n=new Uint8Array(this.buffer,e,t),i=n.indexOf(0);return(new TextDecoder).decode(n.slice(0,i))}_readFileName(e){return this._readString(e,100)}_readFileType(e){let t=new Uint8Array(this.buffer,e+156,1),n=String.fromCharCode(t[0]);return"0"==n?"file":"5"==n?"directory":n}_readFileSize(e){let t=new Uint8Array(this.buffer,e+124,12),n="";for(let e=0;e<11;e++)n+=String.fromCharCode(t[e]);return parseInt(n,8)}_readFileBlob(e,t,n){let i=new Uint8Array(this.buffer,e,t);return new Blob([i],{type:n})}_readFileBinary(e,t){return new Uint8Array(this.buffer,e,t)}_readTextFile(e,t){let n=new Uint8Array(this.buffer,e,t);return(new TextDecoder).decode(n)}getTextFile(e){let t=this.fileInfo.find(t=>t.name==e);if(t)return this._readTextFile(t.header_offset+512,t.size)}getFileBlob(e,t){let n=this.fileInfo.find(t=>t.name==e);if(n)return this._readFileBlob(n.header_offset+512,n.size,t)}getFileBinary(e){let t=this.fileInfo.find(t=>t.name==e);if(t)return this._readFileBinary(t.header_offset+512,t.size)}},TarWriter:class{constructor(){this.fileData=[]}addTextFile(e,t,n){let i=(new TextEncoder).encode(t);this.fileData.push({name:e,array:i,type:"file",size:i.length,dataType:"array",opts:n})}addFileArrayBuffer(e,t,n){let i=new Uint8Array(t);this.fileData.push({name:e,array:i,type:"file",size:i.length,dataType:"array",opts:n})}addFile(e,t,n){this.fileData.push({name:e,file:t,size:t.size,type:"file",dataType:"file",opts:n})}addFolder(e,t){this.fileData.push({name:e,type:"directory",size:0,dataType:"none",opts:t})}_createBuffer(){let e=0;for(let t=0;t<this.fileData.length;t++){let n=this.fileData[t].size;e+=512+512*Math.trunc(n/512),n%512&&(e+=512)}let t=10240*Math.trunc(e/10240);e%10240&&(t+=10240),this.buffer=new ArrayBuffer(t)}async download(e){let t=await this.writeBlob(),n=document.createElement("a");n.href=URL.createObjectURL(t),n.download=e,n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n)}async writeBlob(e){return new Blob([await this.write(e)],{type:"application/x-tar"})}write(e){return new Promise((t,n)=>{this._createBuffer();let i=0,r=0,a=()=>{if(r++,e&&e(r/this.fileData.length*100),r===this.fileData.length){let e=new Uint8Array(this.buffer);t(e)}};for(let e=0;e<this.fileData.length;e++){let t=this.fileData[e];this._writeFileName(t.name,i),this._writeFileType(t.type,i),this._writeFileSize(t.size,i),this._fillHeader(i,t.opts,t.type),this._writeChecksum(i);let n=new Uint8Array(this.buffer,i+512,t.size);if("array"===t.dataType){for(let e=0;e<t.size;e++)n[e]=t.array[e];a()}else if("file"===t.dataType){let e=new FileReader;e.onload=function(e){let t=e;return function(e){let n=e.target.result,i=new Uint8Array(n);for(let e=0;e<i.length;e++)t[e]=i[e];a()}}(n),e.readAsArrayBuffer(t.file)}else"directory"===t.type&&a();i+=512+512*Math.trunc(t.size/512),t.size%512&&(i+=512)}})}_writeString(e,t,n){let i=new Uint8Array(this.buffer,t,n),r=new TextEncoder;if(r.encodeInto)for(let t=r.encodeInto(e,i).written;t<n;t++)i[t]=0;else{let t=r.encode(e);for(let e=0;e<n;e++)i[e]=e<t.length?t[e]:0}}_writeFileName(e,t){this._writeString(e,t,100)}_writeFileType(e,t){let n="0";"file"===e?n="0":"directory"===e&&(n="5"),new Uint8Array(this.buffer,t+156,1)[0]=n.charCodeAt(0)}_writeFileSize(e,t){let n=e.toString(8);n=this._leftPad(n,11),this._writeString(n,t+124,12)}_leftPad(e,t){let n=e+"";for(;n.length<t;)n="0"+n;return n}_writeFileMode(e,t){this._writeString(this._leftPad(e,7),t+100,8)}_writeFileUid(e,t){this._writeString(this._leftPad(e,7),t+108,8)}_writeFileGid(e,t){this._writeString(this._leftPad(e,7),t+116,8)}_writeFileMtime(e,t){this._writeString(this._leftPad(e,11),t+136,12)}_writeFileUser(e,t){this._writeString(e,t+265,32)}_writeFileGroup(e,t){this._writeString(e,t+297,32)}_writeChecksum(e){this._writeString("        ",e+148,8);let t=new Uint8Array(this.buffer,e,512),n=0;for(let e=0;e<512;e++)n+=t[e];this._writeString(n.toString(8),e+148,8)}_getOpt(e,t,n){return null!=e&&null!=e[t]?e[t]:n}_fillHeader(e,t,n){let i=this._getOpt(t,"uid",1e3),r=this._getOpt(t,"gid",1e3),a=this._getOpt(t,"mode","file"===n?"664":"775"),o=this._getOpt(t,"mtime",Date.now()),c=this._getOpt(t,"user","tarballjs"),s=this._getOpt(t,"group","tarballjs");this._writeFileMode(a,e),this._writeFileUid(i.toString(8),e),this._writeFileGid(r.toString(8),e),this._writeFileMtime(Math.trunc(o/1e3).toString(8),e),this._writeString("ustar",e+257,6),this._writeString("00",e+263,2),this._writeFileUser(c,e),this._writeFileGroup(s,e)}}},t=[{match:"(cdn|fastly)\\.jsdelivr\\.net",domain:"cdn.jsdelivr.net",concat:{npm:"/npm(/@{{PACKAGE_SCOPE}})?/({{PACKAGE_NAME}})(@{{PACKAGE_VERSION}})?(/{{$FILE_PATH}})?",github:"/gh/({{USER_NAME}})/({{REPO_NAME}})(@{{TAG_NAME}})?(/{{$FILE_PATH}})?"}},{match:"registry\\.npmmirror\\.com",domain:"registry.npmmirror.com",concat:{npm:"(/@{{PACKAGE_SCOPE}})?/({{PACKAGE_NAME}})(/{{PACKAGE_VERSION}})?/files(/{{$FILE_PATH}})?"},extra:{npm_meta:"(/@{{PACKAGE_SCOPE}})?/({{PACKAGE_NAME}})(/{{$PACKAGE_VERSION}})?",npm_registry:"(@{{PACKAGE_SCOPE}})?/({{PACKAGE_NAME}})/-/({{PACKAGE_NAME}})-({{PACKAGE_VERSION}}).tgz"}},{match:"registry\\.npmjs\\.org",domain:"registry.npmjs.org",concat:{},extra:{npm_meta:"(/@{{PACKAGE_SCOPE}})?/({{PACKAGE_NAME}})(/{{$PACKAGE_VERSION}})?",npm_registry:"(@{{PACKAGE_SCOPE}})?/({{PACKAGE_NAME}})/-/({{PACKAGE_NAME}})-({{PACKAGE_VERSION}}).tgz"}}],n=async e=>new Promise(async(t,n)=>{const i=new Event("abortOtherInstance"),r=new EventTarget,a=setTimeout(()=>{n(new Response("504 All GateWays Failed",{status:504,statusText:"504 All Gateways Timeout"}))},5e3);await Promise.any(e.map(async e=>{"string"==typeof e&&(e=new Request(e));let n=new AbortController,o=!1;r.addEventListener(i.type,()=>{o||n.abort()}),fetch(e,{signal:n.signal,mode:"cors",redirect:"follow"}).then(e=>{200===e.status&&(o=!0,r.dispatchEvent(i),clearTimeout(a),t(e.clone()))}).catch(e=>{"DOMException: The user aborted a request."==e&&console.log()})})).catch(e=>{n(e)})});self.CDNObject=function(i={}){this.config=Object.keys(i).length?i:{cdn:i.cdn?Object.assign({},t,i.cdn):t,cache:i.cache?i.cache:{LatestExpire:86400,UnuseExpire:2592e3}},this.CacheDB=e=>new CacheDB("CDNObject",e);const r=this,a=function(t){if(this.valid=!1,"string"!=typeof t&&"object"!=typeof t)throw new Error("Invalid URL");if(this.url=t,this.urlObject=new URL(t),this.id=r.config.cdn.findIndex(e=>new RegExp(e.match).test(t)),-1===this.id)throw new Error("CDN Not Found:"+t);for(var o in r.config.cdn[this.id].concat)if(this.matchRule=new RegExp(r.config.cdn[this.id].concat[o].replace(/\{\{\$(.*)\}\}/g,"(?<$1>.*)").replace(/\{\{(.*?)\}\}/g,"(?<$1>[^/@]+)").replace(/\//g,"\\/")),t.match(this.matchRule)){this.type=o;break}if(!this.type)throw new Error("CDN Prefix Not Found:"+t);if(this.domain=r.config.cdn[this.id].domain,this.var=t.match(this.matchRule).groups,this.valid=!0,this.genMirror=e=>{const t=r.config.cdn.findIndex(t=>t.domain===e);if(-1===t)throw new Error("CDN Mirror Not Found");if(!r.config.cdn[t].concat[this.type])throw new Error("This Mirror Has No Such Prefix: "+this.type+" ,It only has:"+Object.keys(r.config.cdn[t].concat).join(","));let n=`https://${r.config.cdn[t].domain}${r.config.cdn[t].concat[this.type]}`.replace(/\?/g,"");for(var i in this.var)n=n.replace(new RegExp(`\\(([^)]*)\\{\\{\\$?${i}\\}\\}([^(]*)\\)`,"g"),this.var[i]?`$1${this.var[i]}$2`:"");return new a(n)},this.getAllMirrors=()=>{const e=[];for(var t in r.config.cdn)r.config.cdn[t].concat[this.type]&&e.push({id:t,domain:r.config.cdn[t].domain,cdnObject:this.genMirror(r.config.cdn[t].domain),cdnUrl:this.genMirror(r.config.cdn[t].domain).url});return e},"npm"===this.type){if(this.getNewestVersion=async()=>{const e=["PACKAGE_SCOPE","PACKAGE_NAME"];let t=[];for(var i in r.config.cdn)if("object"==typeof r.config.cdn[i].extra&&r.config.cdn[i].extra.npm_meta){let n=`https://${r.config.cdn[i].domain}${r.config.cdn[i].extra.npm_meta}`;for(var a in this.var)n=n.replace(/\?/g,"").replace(new RegExp(`\\(([^)]*)\\{\\{\\$?${a}\\}\\}([^(]*)\\)`,"g"),-1!==e.indexOf(a)&&this.var[a]?`$1${this.var[a]}$2`:"");t.push(n)}return n(t).then(e=>e.json()).then(e=>e["dist-tags"].latest).catch(e=>null)},"function"!=typeof i.ungzip)return void console.warn("CDNObject: ungzip function not found, pls import pako before inistantiating CDNObject,GetFileFromNPMPackageFunction will not work");const t=`${this.var.PACKAGE_SCOPE?"this.var.PACKAGE_SCOPE/":""}${this.var.PACKAGE_NAME}/${this.var.PACKAGE_VERSION}`;this.packageDownloaded=0,this.packageUntared=0,this.getPackage=async()=>{const e=r.CacheDB("npm_registry"),i=["PACKAGE_SCOPE","PACKAGE_NAME","PACKAGE_VERSION"];let a=[];for(var o in r.config.cdn)if("object"==typeof r.config.cdn[o].extra&&r.config.cdn[o].extra.npm_registry){let e=`https://${r.config.cdn[o].domain}${r.config.cdn[o].extra.npm_registry}`;for(var c in this.var)e=e.replace(/\?/g,"").replace(new RegExp(`\\(([^)]*)\\{\\{\\$?${c}\\}\\}([^(]*)\\)`,"g"),-1!==i.indexOf(c)&&this.var[c]?`$1${this.var[c]}$2`:"");a.push(e)}const s=await n(a).then(e=>e.arrayBuffer()).catch(e=>null);return await e.write(t,s,{type:"arrayBuffer"}),this.packageDownloaded=1,{CachePrefix:"npm_registry",CacheKey:t}},this.deletePackage=async()=>{if(!this.packageDownloaded)throw"need getPackage()";const e=r.CacheDB("npm_registry");return await e.delete(t),this.packageDownloaded=0,!0},this.untarPackage=async()=>{if(!this.packageDownloaded)throw"need getPackage()";const n=r.CacheDB("npm_registry"),i=r.CacheDB("npm"),a=await n.read(t,{type:"arrayBuffer"}),o=ungzip(new Uint8Array(a)),c=new Blob([o],{type:"application/octet-stream"});let s=new e.TarReader;return(await s.readFile(c)).forEach(async e=>{await i.write(`${t}/${e.name.replace(/^package\/?/g,"")}`,s.getFileBinary(e.name),{type:"arrayBuffer"})}),this.packageUntared=1,!0},this.getFileFromPackage=async()=>{if(!this.packageUntared)throw"need untarPackage()";if(!this.var.FILE_PATH)throw"need FILE_PATH";const e=r.CacheDB("npm"),n=`${t}/${this.var.FILE_PATH}`;return e.read(n,{type:"arrayBuffer"})}}};return a};const i={pool:[],add:function(e,t=!0,n=6e4,i="这个任务没有描述"){if(this.pool.push({enable:!0,function:e,interval:n,description:i,lastrun:{time:0}}),t)try{e().then(()=>{})}catch(e){}},run:async function(e){return!!this.pool[e].enable&&!(this.pool[e].lastrun.time+this.pool[e].interval>(new Date).getTime())&&(await this.pool[e].function(),cons.i(`Persistent Task <${this.pool[e].description}> Runned Just Now`),void(this.pool[e].lastrun.time=(new Date).getTime()))},runAll:async function(){return Promise.all(this.pool.map(async(e,t)=>await this.run(t)))},stop:function(e){this.pool[e].enable=!1},start:function(e){this.pool[e].enable=!0},clear:function(){this.pool=[]}},r={s:e=>{console.log(`%c[SUCCESS]%c ${e}`,"color:white;background:green;","")},w:e=>{console.log(`%c[WARNING]%c ${e}`,"color:brown;background:yellow;","")},i:e=>{console.log(`%c[INFO]%c ${e}`,"color:white;background:blue;","")},e:e=>{console.log(`%c[ERROR]%c ${e}`,"color:white;background:red;","")},d:e=>{console.log(`%c[DEBUG]%c ${e}`,"color:white;background:black;","")}};new URL(self.location.href).host;const a={CDN_Fetch_Config:{enable:!0,onlyBody:!1,simpleFetch:!0,parallel:!0,ignore_search:!0,threads:2,origin:!0,timeoutL1:2e3,timeoutL2:5e3,cache:!0,cacheL1:6048e5,cacheL2:2592e6},Blog_Fetch_Config:{enable:!0,onlyBody:!0,simpleFetch:!0,parallel:!0,origin:!0,ignore_search:!0,domain:["blog.eurekac.cn","localhost:48080"],auto_update:{enable:!1,interval:144e5},mirrors:[{type:"url",var:{DOMAIN:"cyan-blog-three.vercel.app",PATH:"/"},weight:-7}],threads:2,timeoutL1:2e3,timeoutL2:5e3,cache:!0,cacheL1:36e5,cacheL2:864e5},CDN_Domain:[{match:"(cdn|fastly)\\.jsdelivr\\.net",domain:"cdn.jsdelivr.net",concat:{npm:"/npm(/@{{PACKAGE_SCOPE}})?/{{PACKAGE_NAME}}(@{{PACKAGE_VERSION}})?(/{{$FILE_PATH}})?",github:"/gh/{{USER_NAME}}/{{REPO_NAME}}/{{$FILE_PATH}}"},weight:0},{match:"cdnjs\\.cloudflare\\.com",domain:"cdnjs.cloudflare.com",concat:{cdnjs:"/ajax/libs/{{PACKAGE_NAME}}/{{PACKAGE_VERSION}}/{{$FILE_PATH}}"},weight:0},{match:"cdn\\.bootcdn\\.net",domain:"cdn.bootcdn.net",concat:{cdnjs:"/ajax/libs/{{PACKAGE_NAME}}/{{PACKAGE_VERSION}}/{{$FILE_PATH}}"},weight:0},{match:"unpkg\\.com",domain:"unpkg.com",concat:{npm:"/{{PACKAGE_NAME}}(@{{PACKAGE_VERSION}})?/{{$FILE_PATH}}"},weight:1},{match:"cdn\\.staticfile\\.org",domain:"cdn.staticfile.org",concat:{cdnjs:"/ajax/libs/{{PACKAGE_NAME}}/{{PACKAGE_VERSION}}/{{$FILE_PATH}}"},weight:0},{match:"registry\\.npmmirror\\.com",domain:"cdn.eurekac.cn",concat:{npm:"(/@{{PACKAGE_SCOPE}})?/{{PACKAGE_NAME}}(/{{PACKAGE_VERSION}})?/files(/{{$FILE_PATH}})"},weight:10}],CyanAcc_Config:{enable:!0,reinit:!0,PersistentTasks:{enable:!0,interval:1e3},AutoClear:{enable:!0,interval:6e4}}};self.cons=r,new URL(self.location.href).protocol,new URL(self.location.href).host;const o=new CacheDB("CyanAcc","CyanAccDB",{auto:1}),c=async()=>{const e=await caches.open("AssetsCache"),t=await e.keys(),n=(new Date).getTime();for(var i of t){const t=await e.match(i);n-Number(t.headers.get("Cache-Time"))>Number(t.headers.get("Cache-L2"))&&await e.delete(i)}};addEventListener("fetch",e=>{try{e.respondWith(s(e.request))}catch(t){return cons.e(`Fatal Error,CyanAcc Will Be disabled:${t}`),void e.respondWith(fetch(e.request))}}),addEventListener("install",self.skipWaiting),addEventListener("activate",self.clients.claim);const s=async e=>{const t=new URL(e.url).host;for(void 0!==self.init&&self.init||(cons.i(`CyanAcc正在重新初始化...在${e.url}`),self.init=!0,self.initTime=(new Date).getTime(),self.Blog_Fetch_Config=await o.read("Blog_Fetch_Config",{default:a.Blog_Fetch_Config}),self.CDN_Domain=await o.read("CDN_Domain",{default:a.CDN_Domain}),self.CDN_Fetch_Config=await o.read("CDN_Fetch_Config",{default:a.CDN_Fetch_Config}),self.CyanAccConfig=await o.read("CyanAcc_Config",{default:a.CyanAcc_Config}),CyanAccConfig.PersistentTasks.enable&&void 0===self.CyanAccInterVal?(cons.i("CyanAcc正在启动持久任务池..."),CyanAccConfig.AutoClear.enable&&i.add(c,!1,CyanAccConfig.AutoClear.interval,"CyanAcc自动清理缓存进程"),self.CyanAccInterVal=setInterval(async()=>{await i.runAll()},CyanAccConfig.PersistentTasks.interval)):cons.w("CyanAcc持久任务池被禁用或者已经启动"),self.initFinished=!0);!self.initFinished;)await new Promise(e=>setTimeout(e,100));if(!CyanAccConfig.enable)return cons.w("CyanAcc已被禁用"),fetch(e);if(Blog_Fetch_Config.domain.includes(t))return BlogRouter(e);for(var n of CDN_Domain)if(e.url.match(new RegExp(n.match)))return CDNRouter(e);return fetch(e)}})();