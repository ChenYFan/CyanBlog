<!DOCTYPE html>
<html lang="zh-cn">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="color-scheme" content="light dark">
  <meta name="baidu-site-verification" content="codeva-fKqX8ua7ka" />
  <link rel="apple-touch-icon" sizes="76x76" href="https://cdn.eurekac.cn/npm/chenyfan-oss/4/files/512.jpg">
  
  <title>欲善其事，必利其器 - 论如何善用ServiceWorker - CyanFalse&#39;s HomeRegion</title>
  
    <link rel="shortcut icon" href="https://cdn.eurekac.cn/npm/chenyfan-oss/6.0.0/files/32.png">
  
  

  
  
  
  <meta property="og:title" content="欲善其事，必利其器 - 论如何善用ServiceWorker - CyanFalse&#39;s HomeRegion" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="https://blog.eurekac.cn/p/c0af86bb.html" />
  
  <meta property="og:image" content="https://cdn.eurekac.cn/npm/chenyfan-os/0.0.0-r25/files/banner/ServiceWorker-is-better.jpg" />
  
  <meta property="og:article:published_time" content="2022-01-16T21:57:45.000Z" />
  
  <meta property="og:article:author" content="CyanFalse" />
  
  
  <link rel="stylesheet" href='/css/var.css'>
  <link rel="stylesheet" href='/css/main.css'>
  <link rel="stylesheet" href='/css/typography.css'>
  <link rel="stylesheet" href='/css/code-highlighting.css'>
  <link rel="stylesheet" href='/css/components.css'>
  <link rel="stylesheet" href='/css/nav.css'>
  <link rel="stylesheet" href='/css/paginator.css'>
  <link rel="stylesheet" href='/css/footer.css'>
  <link rel="stylesheet" href='/css/post-list.css'>
  
  
  <link rel="stylesheet" href='/css/toc.css'>
  
  
  
  
  <link rel="stylesheet" href='/css/post.css'>
  
  
  
  
  
  <!-- <link rel="stylesheet" href="https://cdn.eurekac.cn/npm/lxgw-wenkai-webfont/1.1.0/files/style.css" /> -->
  
    <link rel="stylesheet" href="https://cdn.eurekac.cn/npm/@fancyapps/ui/4.0.31/files/dist/fancybox.css" />
  
  

  <link rel="stylesheet" href="https://cdn.eurekac.cn/npm/notyf/3.10.0/files/notyf.min.css">
<meta name="generator" content="Hexo 6.3.0"></head>
    
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="4"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">
            Eureka Cyan!
        </a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">
                主页
            </a>
            
                <a class="nav-item" href="/archives/">
                    归档
                </a>
                
                <a class="nav-item" href="/friends/">
                    友链
                </a>
                
                <a class="nav-item" href="/categories/">
                    分类
                </a>
                
                <a class="nav-item" target="_blank" rel="noopener" href="https://eurekac.cn">
                    项目主页
                </a>
                
                <a class="nav-item" href="/CyanAcc/#/dashboard">
                    设置
                </a>
                
                    <span>
                        <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank"
                            aria-label="Search" one-link-mark="yes">&nbsp;</a>
                            <!-- <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                                <label>
                                    <input type="radio" value="light">
                                    <span>Light</span>
                                </label>
                                <label>
                                    <input type="radio" value="dark">
                                    <span>Dark</span>
                                </label>
                                <label>
                                    <input type="radio" value="auto">
                                    <span>Auto</span>
                                </label>
                            </div> -->
                    </span>
        </div>
    </div>
</nav>
        
<article class="post">
    <canvas id='map'></canvas>
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/随心扯/">随心扯</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>January</span>
            <span>16,</span>
            <span>2022</span>
        </div>
        

        <h2 class="title">欲善其事，必利其器 - 论如何善用ServiceWorker</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <p>ServiceWorker作为前端革命领袖，毫不夸张地被誉为前端黑科技，此文将阐述如何巧妙的使用它来实现一些看起来匪夷所思的事情。</p>
<span id="more"></span>

<hr>
<blockquote>
<p><strong>Warning</strong><br>此文为最基本的SW使用基础,如果你只是想来白嫖代码的建议退出选择下一篇实操文章.</p>
</blockquote>
<h1 id="起因-巨厦坍塌"><a href="#起因-巨厦坍塌" class="headerlink" title="起因 - 巨厦坍塌"></a>起因 - 巨厦坍塌</h1><p>2021&#x2F;12&#x2F;20日，赶在旧年的末尾，一则<code>JSdelivrSSL证书错误</code>缓缓上了v2ex论坛热点。</p>
<p>此前JSD由于各种原因,曾经不正常了一段时间,所以大家并未对此感冒.正当人们以为这只是JSdelivr每年一度的<code>年经</code>阵痛,发个issue,过一段时间就好了的时候.官方直接爆出大料:<strong>JSDelivr had lost their ICP license</strong></p>
<p>由此可见,过去的几年里,当人们发现JSD对个人面向国内加速拥有者无与伦比的效果时,各种滥用方式层出不穷:图床曾一阵流行,国内搜索引擎JSdelivr十有八九都是作为图床的,连PicGo插件都出了Github+JSdelivr图床;猛一点的,直接做视频床,甚至为了突破单文件20M限制开发了一套ts切片m3u8一条龙服务;作妖的,托管了不少突破网络审查的脚本和规则集;寻死的,添加了大量的政治宗教敏感,有些甚至不配称为宗教,直接上来就是骗钱的.</p>
<p>jsd并不是没有发布许可条款，但这并不能阻止白嫖大军的进程。在羊毛大军中，只要是你是免费的、公益的，你就要做好被薅爆的结果。但是薅羊毛的前提是羊还活着，倘若羊被薅死了，哪来的羊毛给诸君所薅？</p>
<p>总之，不管怎样，JSDelivr在决定将节点设置为<code>NearChina</code>，可以肯定的是，在最近很长一段时间内，我们都无法享受国内外双料同时加速的快感，换句话说，jsd在中国就被永久地打入了冷宫。</p>
<p>视线转向国内，jsd的替代品并不少。早在我写<a target="_blank" rel="noopener" href="https://blog.cyfan.top/p/eb490c73.html">图床的千层套路</a>我就试着假想jsd不可用时，我们该用什么。最终我给出的一份较为完美的答案-npm图床，优点无非就是镜像多速度快，许可条款较为宽松，缺点也很明显，需要安装node，用专门的客户端上传。</p>
<p>那事情就逐渐变得扑朔迷离起来了，我们应当如何选择合理的CDN加速器呢。</p>
<p>这时候，我想起了前端黑科技Serviceworker。是的，这种情况下使用SW最为巧妙不过，它可以在后台自动优选最佳的CDN，甚至可以用黑中黑<code>Promise.any</code>打出一套漂亮的并行拳。经过两天的完善，我终于写出了一套具有离线可达、绕备、优选CDN、跟踪统计合一的SW脚本。<a href="/sw.js">此博客使用的SW</a></p>
<p>接下来我将从头开始讲述ServiceWorker的妙用。</p>
<h1 id="Before-Start"><a href="#Before-Start" class="headerlink" title="Before Start"></a>Before Start</h1><h2 id="What-Is-The-ServiceWorker"><a href="#What-Is-The-ServiceWorker" class="headerlink" title="What Is The ServiceWorker"></a>What Is The ServiceWorker</h2><p>网上对于SW的解释比较模糊，在这里，我将其定义为<code>用户浏览器里的服务器</code>，功能强大到令人发指。是的，接下来的两张图你应该能显著的看到这一差距：</p>
<p><a href="https://npm.elemecdn.com/chenyfan-os@0.0.0-r5/1.jpg" data-fancybox="gallery" data-caption="没有ServiceWorker中继，平淡无奇">
            <img src="https://npm.elemecdn.com/chenyfan-os@0.0.0-r5/1.jpg" class="lazy" data-srcset="https://npm.elemecdn.com/chenyfan-os@0.0.0-r5/1.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABAQMAAAAl21bKAAAABlBMVEXMzMyWlpYU2uzLAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAACklEQVQImWNgAAAAAgAB9HFkpgAAAABJRU5ErkJggg==" alt="没有ServiceWorker中继，平淡无奇">
            </a></p>
<p><a href="https://npm.elemecdn.com/chenyfan-os@0.0.0-r5/2.jpg" data-fancybox="gallery" data-caption="ServiceWorker中继，刺激拉满">
            <img src="https://npm.elemecdn.com/chenyfan-os@0.0.0-r5/2.jpg" class="lazy" data-srcset="https://npm.elemecdn.com/chenyfan-os@0.0.0-r5/2.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABAQMAAAAl21bKAAAABlBMVEXMzMyWlpYU2uzLAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAACklEQVQImWNgAAAAAgAB9HFkpgAAAABJRU5ErkJggg==" alt="ServiceWorker中继，刺激拉满">
            </a></p>
<p>在第一张图中，用户和服务器的关系直的就像电线杆，用户想要什么，服务器就还给他什么。</p>
<p>第二张图中，用户在被ServiceWorker控制的页面中，无论向哪个服务器发起请求，其过程都会被SW捕获，SW可以仿佛不存在一般单纯地请求服务器，返回原本应该返回的内容【透明代理】；也可以对当前服务器返回的内容进行随意的捏造、修改【请求修改结果】；甚至可以将请求指向完全另一台服务器，返回不是此服务器应该返回的内容【移花接木】；当然，SW也可以直接返回已经存储在本地的文件，甚至离线的时候也能返回【离线访问可达性】。</p>
<p>由于SW对于用户页面的操纵实在过于强大，因此，它被设计成<code>不可跨域请求</code>、<code>SW脚本必须在同一域名下</code>、<code>必须在HTTPS条件下运行</code>、<code>不可操纵DOM和BOM</code>，同样的，为了避免阻塞和延迟，SW也被特意设计成<code>完全异步的</code>。这些点将会在后面一一讲述。</p>
<blockquote>
<p>当然，开发者至上，为了方便本地调试，本机地址<code>localhost</code>和<code>127.0.0.1</code>被浏览器所信任，允许以<code>非HTTPS</code>方式运行serviceworker。</p>
</blockquote>
<h2 id="What-Relationship-Between-ServiceWorker-and-PWA"><a href="#What-Relationship-Between-ServiceWorker-and-PWA" class="headerlink" title="What Relationship Between ServiceWorker and PWA"></a>What Relationship Between ServiceWorker and PWA</h2><p>很多人看到sw，第一反应是PWA，即渐进式Web应用。实际上，SW确实是PWA的核心与灵魂，但SW在PWA中起的主要作用是缓存文件，提供给离线访问。并没有完整地发挥出SW的巧妙用法。</p>
<p>SW可以完全脱离PWA存在，当然，PWA可离不开SW ：）</p>
<h2 id="And-WorkBox"><a href="#And-WorkBox" class="headerlink" title="And WorkBox ?"></a>And WorkBox ?</h2><p>WorkBox是谷歌开发的一款基于SW的缓存控制器，其主要目的是方便维护PWA。核心依旧是SW，但还是没有SW原本的自定义程度高（</p>
<h2 id="Why-Not-WorkBox"><a href="#Why-Not-WorkBox" class="headerlink" title="Why Not WorkBox ?"></a>Why Not WorkBox ?</h2><p>首先，博客呢，是没有必要用PWA，有SW做中间件足矣。同时，WorkBox只能简单的缓存数据，并不能做到拦截篡改请求的功能，尤其不能精准把握每一个资源的缓存情况，自定义程度并不高。</p>
<p><del>自己编写SW，格局就打开了</del></p>
<h1 id="Start-From-Zero"><a href="#Start-From-Zero" class="headerlink" title="Start From Zero"></a>Start From Zero</h1><h2 id="安装-Install"><a href="#安装-Install" class="headerlink" title="安装 &#x2F; Install"></a>安装 &#x2F; Install</h2><p>首先，SW的本质是JS脚本，要安装它必须要经过一个html。毕竟，只有拿到了html，JS才能运行于DOM上下文。</p>
<p>剥离层层加成，安装的代码只有一行</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">navigator.<span class="property">serviceWorker</span>.<span class="title function_">register</span>(<span class="string">&#x27;/sw.js&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>其中，<code>/sw.js</code>即为ServiceWorker脚本所在，由于安全性，你不能加载跨域的SW。</p>
<p>例如，当前网页为<code>https://blog.cyfan.top</code>，以下加载位置是允许的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/sw.js</span><br><span class="line">https://blog.cyfan.top/sw.js</span><br></pre></td></tr></table></figure>

<p>以下加载是不允许的:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http://blog.cyfan.top/sw.js#非HTTPS</span><br><span class="line">https://cyfan.top/sw.js#非同一域名，视为跨域</span><br><span class="line">https://119.91.80.151:59996/sw.js#虽然为同一文件,但非同一域名，视为跨域</span><br><span class="line">./sw.js#容易造成SW脚本获取路径不一致</span><br></pre></td></tr></table></figure>

<p>在加载前，我们最好判断一下dom是否加载完了，不然安装sw可能会卡dom</p>
<p>加载完成后，register函数将返回一个<code>Promise</code>，由于前端大多不适用于<code>异步</code>，我们通常以<code>同步</code>的方式<code>.then()</code>和<code>.catch()</code>来获取是否加载成功。</p>
<p>为了方便判断脚本是否能够加载，我们还要判断navigator里有无sw这一属性<code>&#39;serviceWorker&#39; in navigator</code>。</p>
<p>由于SW安装后，页面需要刷新后才能交给SW所宰割，同时为了避免浏览器缓存的影响，我通常采用修改<code>search</code>的方式强刷新，而不是通过<code>reload</code>函数。同样的，为了避免刚安装完就刷新的尴尬感，建议用<code>setTimeout</code>延迟一秒刷新。</p>
<p>简易的完整安装代码如下:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;load&#x27;</span>, <span class="keyword">async</span> () =&gt; &#123;</span></span><br><span class="line"><span class="language-javascript">    navigator.<span class="property">serviceWorker</span>.<span class="title function_">register</span>(<span class="string">`/sw.js?time=<span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>().getTime()&#125;</span>`</span>)</span></span><br><span class="line"><span class="language-javascript">        .<span class="title function_">then</span>(<span class="keyword">async</span> reg =&gt; &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//安装成功，建议此处强刷新以立刻执行SW</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;install&#x27;</span>) != <span class="string">&#x27;true&#x27;</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">window</span>.<span class="property">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;install&#x27;</span>, <span class="string">&#x27;true&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">search</span> = <span class="string">`?time=<span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>().getTime()&#125;</span>`</span></span></span><br><span class="line"><span class="language-javascript">                &#125;, <span class="number">1000</span>)</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;).<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//安装失败，错误信息会由err传参</span></span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">&#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>一刷新，世界就变成了ServiceWorker的瓮中之鳖，接下来，该是SW脚本正式登场的时候了。</p>
<h2 id="SW安装初始化-Installations"><a href="#SW安装初始化-Installations" class="headerlink" title="SW安装初始化 &#x2F; Installations"></a>SW安装初始化 &#x2F; Installations</h2><p>首先，先尴尬的开一个空缓存列表：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">CACHE_NAME</span> = <span class="string">&#x27;ICDNCache&#x27;</span>;<span class="comment">//可以为Cache版本号，但这样可能会导致缓存冗余累积</span></span><br><span class="line"><span class="keyword">let</span> cachelist = [];</span><br></pre></td></tr></table></figure>

<p><code>cachelist</code>里面填写的是预缓存网址，例如在离线时返回的错误页面。此处不宜添加过多网址，此处点名@一下Akilar。</p>
<p>此处我建议只缓存离线页面展示的内容:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> cachelist = [</span><br><span class="line">    <span class="string">&#x27;/offline.html&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;https://npm.elemecdn.com/chenyfan-os@0.0.0-r6&#x27;</span></span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>同时监听sw安装时开启此缓存空间：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">self.<span class="title function_">addEventListener</span>(<span class="string">&#x27;install&#x27;</span>, <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">installEvent</span>) &#123;</span><br><span class="line">    self.<span class="title function_">skipWaiting</span>();</span><br><span class="line">    installEvent.<span class="title function_">waitUntil</span>(</span><br><span class="line">        caches.<span class="title function_">open</span>(<span class="variable constant_">CACHE_NAME</span>)</span><br><span class="line">            .<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">cache</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Opened cache&#x27;</span>);</span><br><span class="line">                <span class="keyword">return</span> cache.<span class="title function_">addAll</span>(cachelist);</span><br><span class="line">            &#125;)</span><br><span class="line">    );</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>由于SW完全没有办法访问DOM，因此对于全局变量，不应当用<code>window</code>，而是<code>self</code>指代自己。</p>
<p><code>addEventListener</code>这一监听器将监听<code>install</code>,也就是这一段代码只会在脚本首次安装和更新时运行.</p>
<p><code>skipWaiting</code>的作用是促进新版本sw跳过waiting这一阶段，直接active。</p>
<blockquote>
<p>关于SW的状态（waiting，installing，activing）将在文后详细解释。</p>
</blockquote>
<p><code>installEvent.waitUntil</code>的作用是直接结束安装过程的等待，待会在后台完成开启缓存空间这一操作。</p>
<p><code>cache.addAll</code>将会直接获取<code>cachelist</code>里面所有的网址并直接缓存到CacheStorage。如果此处网址过多，将在页面加载时疯狂请求所有的url<del>(例如1k个)</del></p>
<p>现在，SW初始化已经完成了。接下来，我将讲述SW如何捕获页面的请求。</p>
<h2 id="捕获请求-Fetch-Event"><a href="#捕获请求-Fetch-Event" class="headerlink" title="捕获请求 &#x2F; Fetch Event"></a>捕获请求 &#x2F; Fetch Event</h2><h3 id="添加监听器-AddEventListener"><a href="#添加监听器-AddEventListener" class="headerlink" title="添加监听器 &#x2F; AddEventListener"></a>添加监听器 &#x2F; AddEventListener</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">self.<span class="title function_">addEventListener</span>(<span class="string">&#x27;fetch&#x27;</span>, <span class="keyword">async</span> event =&gt; &#123;</span><br><span class="line">    event.<span class="title function_">respondWith</span>(<span class="title function_">handle</span>(event.<span class="property">request</span>))</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handle</span> = <span class="keyword">async</span>(<span class="params">req</span>)=&gt;&#123;</span><br><span class="line">    <span class="comment">//do something</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一行很简单，绑定一个监听器，监听<code>fetch</code>事件，即网页向服务器获取请求，也就是相当于前端的<code>XMLHTTPRequest</code></p>
<p><code>event.respondWith</code>即设定返回内容，交给<code>handle</code>主函数处理，传参<code>event.request</code>。这是一个<code>Request</code>对象，里面包含了请求的详细信息。</p>
<p>接下来，我们开始实战吧。</p>
<blockquote>
<p>以下所有内容均针对handle修改</p>
</blockquote>
<h3 id="透明代理-Transparent-Proxy"><a href="#透明代理-Transparent-Proxy" class="headerlink" title="透明代理 &#x2F; Transparent Proxy"></a>透明代理 &#x2F; Transparent Proxy</h3><p>顾名思义，此实战脚本的作用是SW代理目前的所有流量但不进行修改，仿佛SW不存在一般。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">handle</span> = <span class="keyword">async</span>(<span class="params">req</span>)=&gt;&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">fetch</span>(req)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>fetch</code>这个函数相当于前端的<code>ajax</code>或者<code>XMLHTTPRequest</code>，作用是发起一个请求，获得一个返回值。由于sw不可访问<code>window</code>，在sw中是无法使用<code>ajax</code>或<code>XMLHTTPRequest</code>。同时，<code>fetch</code>是一个异步函数，直接调用它会返回一个<code>Promise</code>。</p>
<p><code>fetch</code>只能传递<code>Requset</code>对象,而<code>Requset</code>对象有两个参数<code>(url,[option])</code>,第一个参数是网址,第二个参数为<code>Request</code>的内容,例如<code>body</code>或<code>header</code>。</p>
<p>此脚本适用于卸载<code>ServiceWorker</code>的替换脚本。因为sw在无法拉取新版本时不会主动卸载，依旧保持运行，填入一个透明代理sw即可。</p>
<p>由于SW冷启动【即页面关闭后SW】处于暂停状态是从硬盘读取的，这会导致第一次请求有少许性能延迟[~10ms]。</p>
<h3 id="篡改请求-Edit-Requset"><a href="#篡改请求-Edit-Requset" class="headerlink" title="篡改请求 &#x2F; Edit Requset"></a>篡改请求 &#x2F; Edit Requset</h3><p>对于一张图片，有时候服务端会变态到让你必须用<code>POST</code>协议才能获得，此时用SW篡改最为方便。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">handle</span> = <span class="keyword">async</span> (<span class="params">req</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> ((req.<span class="property">url</span>.<span class="title function_">split</span>(<span class="string">&#x27;/&#x27;</span>))[<span class="number">2</span>].<span class="title function_">match</span>(<span class="string">&#x27;xxx.com&#x27;</span>)) &#123;</span><br><span class="line">        <span class="comment">//xxx.com为图片所在域名</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">fetch</span>(req.<span class="property">url</span>, &#123;</span><br><span class="line">            <span class="attr">method</span>: <span class="string">&quot;POST&quot;</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">fetch</span>(req)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意，在ServiceWorker里面，header头是不能修改refferer和origin的，因此此方法无法绕开新浪图床反盗链</p>
</blockquote>
<h3 id="篡改响应-Edit-Response"><a href="#篡改响应-Edit-Response" class="headerlink" title="篡改响应 &#x2F; Edit Response"></a>篡改响应 &#x2F; Edit Response</h3><p>这个例子会检测返回内容，若为html，将把所有的”TEST”都替换成”SHIT”</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">handle</span> = <span class="keyword">async</span> (<span class="params">req</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">fetch</span>(req)</span><br><span class="line">    <span class="keyword">const</span> resp = res.<span class="title function_">clone</span>()</span><br><span class="line">    <span class="keyword">if</span> (!!resp.<span class="property">headers</span>.<span class="title function_">get</span>(<span class="string">&#x27;content-type&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (resp.<span class="property">headers</span>.<span class="title function_">get</span>(<span class="string">&#x27;content-type&#x27;</span>).<span class="title function_">includes</span>(<span class="string">&#x27;text/html&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>((<span class="keyword">await</span> resp.<span class="title function_">text</span>()).<span class="title function_">replace</span>(<span class="regexp">/TEST/g</span>, <span class="string">&#x27;SHIT&#x27;</span>), &#123;</span><br><span class="line">                <span class="attr">headers</span>: resp.<span class="property">headers</span>,</span><br><span class="line">                <span class="attr">status</span>: resp.<span class="property">status</span></span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> resp</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>const resp = res.clone()</code>由于<code>Response</code>的<code>body</code>一旦被读取，这个<code>body</code>就会被锁死，再也无法读取。<code>clone()</code>能够创造出响应的副本用于处理。</p>
<p><code>resp.headers.get(&#39;content-type&#39;)</code>通过读取响应的头，判断是否包含<code>text/html</code>，如果是，将响应以<code>text()</code>异步流的方式读取，然后正则替换掉响应内容，并还原头和响应Code。</p>
<p>返回的内容必须是<code>Response</code>对象，所以<code>new Response</code>构建一个新对象，并直接返回。不匹配html头将直接原封不动地透明代理。</p>
<h3 id="移花接木-Graft-Request-To-Another-Server"><a href="#移花接木-Graft-Request-To-Another-Server" class="headerlink" title="移花接木 &#x2F; Graft Request To Another Server"></a>移花接木 &#x2F; Graft Request To Another Server</h3><p><code>unpkg.zhimg.com</code>是<code>unpkg.com</code>的镜像网站。此脚本将会把所有的<code>unpkg.com</code>流量直接拦截到<code>unpkg.zhimg.com</code>，用于中国大陆内CDN加速。</p>
<p>由于npm镜像固定为GET请求方式并且没有其他鉴权需求，所以我们没有必要还原<code>Request</code>其他数据。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">handle</span> = <span class="keyword">async</span> (<span class="params">req</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> domain = req.<span class="property">url</span>.<span class="title function_">split</span>(<span class="string">&#x27;/&#x27;</span>)[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">if</span> (domain.<span class="title function_">match</span>(<span class="string">&quot;unpkg.com&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">fetch</span>(req.<span class="property">url</span>.<span class="title function_">replace</span>(<span class="string">&quot;https://unpkg.com&quot;</span>, <span class="string">&quot;https://zhimg.unpkg.com&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">fetch</span>(req)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>domain.match</code>捕获请求中是否有待替换域名，检查出来后直接<code>replace</code>掉域名，如果没有匹配到，直接透明代理走掉。</p>
<h3 id="并行请求-Request-Parallelly"><a href="#并行请求-Request-Parallelly" class="headerlink" title="并行请求 &#x2F; Request Parallelly"></a>并行请求 &#x2F; Request Parallelly</h3><p>SW中又一大黑科技隆重登场&#x3D;&gt;<code>Promise.any</code>，这个函数拥有另外两个衍生兄弟<code>Promise.all</code>&amp;<code>Promise.race</code>。下面我将简单介绍这三种方式</p>
<h4 id="Promose-all"><a href="#Promose-all" class="headerlink" title="Promose.all"></a>Promose.all</h4><p>当列表中所有的<code>Promise</code>都<code>resolve</code>[即成功]后，这个函数才会返回<code>resolve</code>，只要有一个返回<code>reject</code>，整个函数都会<code>reject</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">    <span class="title function_">fetch</span>(<span class="string">&#x27;https://unpkg.com/jquery&#x27;</span>),</span><br><span class="line">    <span class="title function_">fetch</span>(<span class="string">&#x27;https://cdn.jsdelivr.net/npm/jquery&#x27;</span>),</span><br><span class="line">    <span class="title function_">fetch</span>(<span class="string">&#x27;https://unpkg.zhimg.com/jquery&#x27;</span>)</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<p>这个函数将会请求三个网址，当每一个网址都链接联通后，整个函数将会返回一个列表：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="title class_">Response1</span>,<span class="title class_">Response2</span>,<span class="title class_">Response3</span>]</span><br></pre></td></tr></table></figure>

<p>当任何一个<code>fetch</code>失败[即<code>reject</code>]后，整个<code>Promise.all</code>函数都会直接<code>reject</code>并报错。</p>
<p>此函数可以检测网络连通性，由于采取并行处理，相比以前的循环效率要高不少。</p>
<p>这是一段检测国内国外网络连通性的测试。</p>
<p>没有采用<code>Promise.all</code>的代码和效果：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">test</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> url = [</span><br><span class="line">        </span><br><span class="line">        <span class="string">&quot;https://cdn.jsdelivr.net/npm/jquery@3.6.0/package.json&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://unpkg.com/jquery@3.6.0/package.json&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://unpkg.zhimg.com/jquery@3.6.0/package.json&quot;</span></span><br><span class="line">    ]</span><br><span class="line">    flag = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> url) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">fetch</span>(url[i])</span><br><span class="line">            <span class="keyword">if</span> (res.<span class="property">status</span> !== <span class="number">200</span>) &#123;</span><br><span class="line">                flag = <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(n)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> flag</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://npm.elemecdn.com/chenyfan-os@0.0.0-r7/1.png" data-fancybox="gallery" data-caption="该图片无描述">
            <img src="https://npm.elemecdn.com/chenyfan-os@0.0.0-r7/1.png" class="lazy" data-srcset="https://npm.elemecdn.com/chenyfan-os@0.0.0-r7/1.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABAQMAAAAl21bKAAAABlBMVEXMzMyWlpYU2uzLAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAACklEQVQImWNgAAAAAgAB9HFkpgAAAABJRU5ErkJggg==">
            </a></p>
<p>采用循环，<code>await</code>会堵塞循环，直到这次请求完成后才能执行下一个。如果有任何一个url长时间无法联通，将会导致极长的检测时间浪费。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">test</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> url = [</span><br><span class="line">        <span class="string">&quot;https://cdn.jsdelivr.net/npm/jquery@3.6.0/package.json&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://unpkg.com/jquery@3.6.0/package.json&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://unpkg.zhimg.com/jquery@3.6.0/package.json&quot;</span></span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(url.<span class="title function_">map</span>(<span class="function"><span class="params">url</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="title function_">fetch</span>(url)</span><br><span class="line">                .<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (res.<span class="property">status</span> == <span class="number">200</span>) &#123;</span><br><span class="line">                        <span class="title function_">resolve</span>(<span class="literal">true</span>)</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="title function_">reject</span>(<span class="literal">false</span>)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                .<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="title function_">reject</span>(<span class="literal">false</span>)</span><br><span class="line">                &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    )).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;).<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://npm.elemecdn.com/chenyfan-os@0.0.0-r7/2.png" data-fancybox="gallery" data-caption="该图片无描述">
            <img src="https://npm.elemecdn.com/chenyfan-os@0.0.0-r7/2.png" class="lazy" data-srcset="https://npm.elemecdn.com/chenyfan-os@0.0.0-r7/2.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABAQMAAAAl21bKAAAABlBMVEXMzMyWlpYU2uzLAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAACklEQVQImWNgAAAAAgAB9HFkpgAAAABJRU5ErkJggg==">
            </a></p>
<p><code>Promise.all</code>几乎在一瞬间请求所有的url，其请求时并行，每一个请求并不会堵塞其他请求，函数总耗时为最长请求耗时。</p>
<h4 id="Promise-race"><a href="#Promise-race" class="headerlink" title="Promise.race"></a>Promise.race</h4><p>此函数也是并行执行，不过与all不同的是，只要有任何一个函数完成，就立刻返回，无论其是否<code>reject</code>或者<code>resolve</code>。</p>
<p>这个函数比较适合用于同时请求一些不关心结果，只要访问达到了即可，例如统计、签到等应用场景。</p>
<h4 id="Promise-any"><a href="#Promise-any" class="headerlink" title="Promise.any"></a>Promise.any</h4><p>这个函数非常的有用，其作用和<code>race</code>接近，不过与之不同的是，<code>any</code>会同时检测结果是否<code>resolve</code>。其并行处理后，只要有任何一个返回正确，就直接返回哪个最快的请求结果，返回错误的直接忽视，除非所有的请求都失败了，才会返回<code>reject</code></p>
<p>这是一段同时请求<code>jquery</code>的<code>package.json</code>代码，它将从四个镜像同时请求：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">get_json</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> urllist = [</span><br><span class="line">            <span class="string">&quot;https://cdn.jsdelivr.net/npm/jquery@3.6.0/package.json&quot;</span>,</span><br><span class="line">            <span class="string">&quot;https://unpkg.com/jquery@3.6.0/package.json&quot;</span>,</span><br><span class="line">            <span class="string">&quot;https://unpkg.zhimg.com/jquery@3.6.0/package.json&quot;</span>,</span><br><span class="line">            <span class="string">&quot;https://npm.elemecdn.com/jquery@3.6.0/package.json&quot;</span></span><br><span class="line">        ]</span><br><span class="line">        <span class="title class_">Promise</span>.<span class="title function_">any</span>(urllist.<span class="title function_">map</span>(<span class="function"><span class="params">url</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="title function_">fetch</span>(url)</span><br><span class="line">                .<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (res.<span class="property">status</span> == <span class="number">200</span>) &#123;</span><br><span class="line">                        <span class="title function_">resolve</span>(res)</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="title function_">reject</span>()</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;).<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="title function_">reject</span>()</span><br><span class="line">                &#125;)</span><br><span class="line">        &#125;))</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">await</span>(<span class="keyword">await</span> <span class="title function_">get_json</span>()).<span class="title function_">text</span>())</span><br></pre></td></tr></table></figure>

<p><a href="https://npm.elemecdn.com/chenyfan-os@0.0.0-r7/3.png" data-fancybox="gallery" data-caption="该图片无描述">
            <img src="https://npm.elemecdn.com/chenyfan-os@0.0.0-r7/3.png" class="lazy" data-srcset="https://npm.elemecdn.com/chenyfan-os@0.0.0-r7/3.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABAQMAAAAl21bKAAAABlBMVEXMzMyWlpYU2uzLAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAACklEQVQImWNgAAAAAgAB9HFkpgAAAABJRU5ErkJggg==">
            </a></p>
<p>函数将会在<code>21ms</code>上下返回json中的数据。</p>
<p>此函数的好处在于可以在用户客户端判断哪一个镜像发挥速度最快，并保证用户每一次获取都能达到最大速度。同时，任何一个镜像站崩溃了都不会造成太大的影响，脚本将自动从其他源拉取信息。</p>
<p>除非所有源都炸了，否则此请求不会失败。</p>
<p>但是，我们会额外地发现，当知乎镜像返回最新版本后，其余的请求依旧在继续，只是没有被利用到而已。</p>
<p>这会堵塞浏览器并发线程数，并且会造成额外的流量浪费。所以我们应该在其中任何一个请求完成后就打断其余请求。</p>
<p><code>fetch</code>有一个<code>abort</code>对象，只要刚开始<code>new AbortController()</code>指定控制器，在<code>init</code>的里面指定控制器的<code>signal</code>即可将其标记为待打断函数，最后<code>controller.abort()</code>即可打断。</p>
<p>那么，很多同学就会开始这么写了:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">get_json</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> controller = <span class="keyword">new</span> <span class="title class_">AbortController</span>();</span><br><span class="line">        <span class="keyword">const</span> urllist = [</span><br><span class="line">            <span class="string">&quot;https://cdn.jsdelivr.net/npm/jquery@3.6.0/package.json&quot;</span>,</span><br><span class="line">            <span class="string">&quot;https://unpkg.com/jquery@3.6.0/package.json&quot;</span>,</span><br><span class="line">            <span class="string">&quot;https://unpkg.zhimg.com/jquery@3.6.0/package.json&quot;</span>,</span><br><span class="line">            <span class="string">&quot;https://npm.elemecdn.com/jquery@3.6.0/package.json&quot;</span></span><br><span class="line">        ]</span><br><span class="line">        <span class="title class_">Promise</span>.<span class="title function_">any</span>(urllist.<span class="title function_">map</span>(<span class="function"><span class="params">url</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="title function_">fetch</span>(url,&#123;</span><br><span class="line">                <span class="attr">signal</span>: controller.<span class="property">signal</span></span><br><span class="line">            &#125;)</span><br><span class="line">                .<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (res.<span class="property">status</span> == <span class="number">200</span>) &#123;</span><br><span class="line">                        controller.<span class="title function_">abort</span>();</span><br><span class="line">                        <span class="title function_">resolve</span>(res)</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="title function_">reject</span>()</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;).<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="title function_">reject</span>()</span><br><span class="line">                &#125;)</span><br><span class="line">        &#125;))</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">await</span>(<span class="keyword">await</span> <span class="title function_">get_json</span>()).<span class="title function_">text</span>())</span><br></pre></td></tr></table></figure>

<p>但很快，你就会发现它报错了：<code>Uncaught DOMException: The user aborted a request.</code>，并且没有任何数据输出。</p>
<p>让我们看一下Network选项卡：</p>
<p><a href="https://npm.elemecdn.com/chenyfan-os@0.0.0-r7/4.png" data-fancybox="gallery" data-caption="该图片无描述">
            <img src="https://npm.elemecdn.com/chenyfan-os@0.0.0-r7/4.png" class="lazy" data-srcset="https://npm.elemecdn.com/chenyfan-os@0.0.0-r7/4.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABAQMAAAAl21bKAAAABlBMVEXMzMyWlpYU2uzLAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAACklEQVQImWNgAAAAAgAB9HFkpgAAAABJRU5ErkJggg==">
            </a></p>
<p>其中，知乎返回的最快，但他并没有完整的返回文件[源文件1.8KB，但他只返回了1.4KB]。这也直接导致了整个函数的<code>fail</code>。</p>
<p>原因出在<code>fetch</code>上，这个函数在获得响应之后就立刻<code>resolve</code>了<code>Response</code>，但这个时候<code>body</code>并没有下载完成，即<code>fetch</code>的返回基于状态的而非基于响应内容，当其中<code>fetch</code>已经拿到了完整的状态代码，它就立刻把<code>Response</code>丢给了下一个管道函数，而此时<code>status</code>正确，<code>abort</code>打断了包括这一个<code>fetch</code>的所有请求，<code>fetch</code>就直接工作不正常。</p>
<p>我个人采取的方式是读取<code>arrayBuffer</code>，阻塞<code>fetch</code>函数直到把整个文件下载下来。函数名为<code>PauseProgress</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">get_json</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> controller = <span class="keyword">new</span> <span class="title class_">AbortController</span>();</span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">PauseProgress</span> = <span class="keyword">async</span> (<span class="params">res</span>) =&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>(<span class="keyword">await</span> (res).<span class="title function_">arrayBuffer</span>(), &#123; <span class="attr">status</span>: res.<span class="property">status</span>, <span class="attr">headers</span>: res.<span class="property">headers</span> &#125;);</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">const</span> urllist = [</span><br><span class="line">            <span class="string">&quot;https://cdn.jsdelivr.net/npm/jquery@3.6.0/package.json&quot;</span>,</span><br><span class="line">            <span class="string">&quot;https://unpkg.com/jquery@3.6.0/package.json&quot;</span>,</span><br><span class="line">            <span class="string">&quot;https://unpkg.zhimg.com/jquery@3.6.0/package.json&quot;</span>,</span><br><span class="line">            <span class="string">&quot;https://npm.elemecdn.com/jquery@3.6.0/package.json&quot;</span></span><br><span class="line">        ]</span><br><span class="line">        <span class="title class_">Promise</span>.<span class="title function_">any</span>(urllist.<span class="title function_">map</span>(<span class="function"><span class="params">url</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="title function_">fetch</span>(url, &#123;</span><br><span class="line">                <span class="attr">signal</span>: controller.<span class="property">signal</span></span><br><span class="line">            &#125;)</span><br><span class="line">                .<span class="title function_">then</span>(<span class="title class_">PauseProgress</span>)</span><br><span class="line">                .<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (res.<span class="property">status</span> == <span class="number">200</span>) &#123;</span><br><span class="line">                        controller.<span class="title function_">abort</span>();</span><br><span class="line">                        <span class="title function_">resolve</span>(res)</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="title function_">reject</span>()</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;).<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="title function_">reject</span>()</span><br><span class="line">                &#125;)</span><br><span class="line">        &#125;))</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">await</span>(<span class="keyword">await</span> <span class="title function_">get_json</span>()).<span class="title function_">text</span>())</span><br></pre></td></tr></table></figure>

<p><a href="https://npm.elemecdn.com/chenyfan-os@0.0.0-r7/5.png" data-fancybox="gallery" data-caption="该图片无描述">
            <img src="https://npm.elemecdn.com/chenyfan-os@0.0.0-r7/5.png" class="lazy" data-srcset="https://npm.elemecdn.com/chenyfan-os@0.0.0-r7/5.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABAQMAAAAl21bKAAAABlBMVEXMzMyWlpYU2uzLAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAACklEQVQImWNgAAAAAgAB9HFkpgAAAABJRU5ErkJggg==">
            </a></p>
<p>在这其中通过<code>arrayBuffer()</code>方法异步读取<code>res</code>的<code>body</code>，将其读取为二进制文件，并新建一个新的<code>Response</code>，还原状态和头，然后丢给管道函数同步处理。</p>
<p>在这里，我们就实现了暴力并发，以流量换速度的方式。同时也获得了一个高可用的SW负载均衡器。</p>
<p>这一段函数可以这样写在SW中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">lfetch</span> = (<span class="params">urllist</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> controller = <span class="keyword">new</span> <span class="title class_">AbortController</span>();</span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">PauseProgress</span> = <span class="keyword">async</span> (<span class="params">res</span>) =&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>(<span class="keyword">await</span> (res).<span class="title function_">arrayBuffer</span>(), &#123; <span class="attr">status</span>: res.<span class="property">status</span>, <span class="attr">headers</span>: res.<span class="property">headers</span> &#125;);</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="title class_">Promise</span>.<span class="title function_">any</span>(urllist.<span class="title function_">map</span>(<span class="function"><span class="params">url</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="title function_">fetch</span>(url, &#123;</span><br><span class="line">                <span class="attr">signal</span>: controller.<span class="property">signal</span></span><br><span class="line">            &#125;)</span><br><span class="line">                .<span class="title function_">then</span>(<span class="title class_">PauseProgress</span>)</span><br><span class="line">                .<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (res.<span class="property">status</span> == <span class="number">200</span>) &#123;</span><br><span class="line">                        controller.<span class="title function_">abort</span>();</span><br><span class="line">                        <span class="title function_">resolve</span>(res)</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="title function_">reject</span>()</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;).<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="title function_">reject</span>()</span><br><span class="line">                &#125;)</span><br><span class="line">        &#125;))</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handle</span> = <span class="keyword">async</span> (<span class="params">req</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> npm_mirror = [</span><br><span class="line">        <span class="string">&#x27;https://cdn.jsdelivr.net/npm/&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;https://unpkg.com/&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;https://npm.elemecdn.com/&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;https://unpkg.zhimg.com/&#x27;</span></span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> k <span class="keyword">in</span> npm_mirror) &#123;</span><br><span class="line">        <span class="keyword">if</span> (req.<span class="property">url</span>.<span class="title function_">match</span>(npm_mirror[k]) &amp;&amp; req.<span class="property">url</span>.<span class="title function_">replace</span>(<span class="string">&#x27;https://&#x27;</span>, <span class="string">&#x27;&#x27;</span>).<span class="title function_">split</span>(<span class="string">&#x27;/&#x27;</span>)[<span class="number">0</span>] == npm_mirror[k].<span class="title function_">replace</span>(<span class="string">&#x27;https://&#x27;</span>, <span class="string">&#x27;&#x27;</span>).<span class="title function_">split</span>(<span class="string">&#x27;/&#x27;</span>)[<span class="number">0</span>]) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">lfetch</span>((<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> l = []</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; npm_mirror.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                    l.<span class="title function_">push</span>(npm_mirror[i] + req.<span class="property">url</span>.<span class="title function_">split</span>(<span class="string">&#x27;/&#x27;</span>)[<span class="number">3</span>])</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> l</span><br><span class="line">            &#125;)())</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">fetch</span>(req)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外,<code>Promise.any</code>,兼容性比较差:</p>
<p><a href="https://npm.elemecdn.com/chenyfan-os@0.0.0-r9/1.png" data-fancybox="gallery" data-caption="该图片无描述">
            <img src="https://npm.elemecdn.com/chenyfan-os@0.0.0-r9/1.png" class="lazy" data-srcset="https://npm.elemecdn.com/chenyfan-os@0.0.0-r9/1.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABAQMAAAAl21bKAAAABlBMVEXMzMyWlpYU2uzLAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAACklEQVQImWNgAAAAAgAB9HFkpgAAAABJRU5ErkJggg==">
            </a></p>
<p>因此,我的解决办法是判断浏览器如果不支持,就提前polyfill一下:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="title class_">Promise</span>.<span class="property">any</span>) &#123;</span><br><span class="line">        <span class="title class_">Promise</span>.<span class="property">any</span> = <span class="keyword">function</span> (<span class="params">promises</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">                promises = <span class="title class_">Array</span>.<span class="title function_">isArray</span>(promises) ? promises : []</span><br><span class="line">                <span class="keyword">let</span> len = promises.<span class="property">length</span></span><br><span class="line">                <span class="keyword">let</span> errs = []</span><br><span class="line">                <span class="keyword">if</span> (len === <span class="number">0</span>) <span class="keyword">return</span> <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">AggregateError</span>(<span class="string">&#x27;All promises were rejected&#x27;</span>))</span><br><span class="line">                promises.<span class="title function_">forEach</span>(<span class="function">(<span class="params">promise</span>) =&gt;</span> &#123;</span><br><span class="line">                    promise.<span class="title function_">then</span>(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">                        <span class="title function_">resolve</span>(value)</span><br><span class="line">                    &#125;, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">                        len--</span><br><span class="line">                        errs.<span class="title function_">push</span>(err)</span><br><span class="line">                        <span class="keyword">if</span> (len === <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">AggregateError</span>(errs))</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="缓存控制-Cache"><a href="#缓存控制-Cache" class="headerlink" title="缓存控制 &#x2F; Cache"></a>缓存控制 &#x2F; Cache</h2><h3 id="持久化缓存-Cache-Persistently"><a href="#持久化缓存-Cache-Persistently" class="headerlink" title="持久化缓存 &#x2F; Cache Persistently"></a>持久化缓存 &#x2F; Cache Persistently</h3><p>对于来自CDN的流量，大部分是持久不变的，因此，如果我们将文件获得后直接填入缓存，之后访问也直接从本地缓存中读取，那将大大提升访问速度。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">handle</span> = <span class="keyword">async</span> (<span class="params">req</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> cache_url_list = [</span><br><span class="line">        <span class="regexp">/(http:\/\/|https:\/\/)cdn\.jsdelivr\.net/g</span>,</span><br><span class="line">        <span class="regexp">/(http:\/\/|https:\/\/)cdn\.bootcss\.com/g</span>,</span><br><span class="line">        <span class="regexp">/(http:\/\/|https:\/\/)zhimg\.unpkg\.com/g</span>,</span><br><span class="line">        <span class="regexp">/(http:\/\/|https:\/\/)unpkg\.com/g</span></span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> cache_url_list) &#123;</span><br><span class="line">        <span class="keyword">if</span> (req.<span class="property">url</span>.<span class="title function_">match</span>(cache_url_list[i])) &#123;</span><br><span class="line">            <span class="keyword">return</span> caches.<span class="title function_">match</span>(req).<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">resp</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> resp || <span class="title function_">fetch</span>(req).<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">res</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> caches.<span class="title function_">open</span>(<span class="variable constant_">CACHE_NAME</span>).<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">cache</span>) &#123;</span><br><span class="line">                        cache.<span class="title function_">put</span>(req, res.<span class="title function_">clone</span>());</span><br><span class="line">                        <span class="keyword">return</span> res;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">fetch</span>(req)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>cache_url_list</code>列出所有待匹配的域名(包括http&#x2F;https头是为了避免误杀其他url)，然后<code>for</code>开始遍历待列表，如果url中匹配到了，开始执行返回缓存操作。</p>
<p>cache是一个近似于Key&#x2F;Value(键名&#x2F;键值)，只要有对应的<code>Request</code>(<code>KEY</code>)，就能匹配到响应的<code>Response</code>(<code>VALUE</code>)。</p>
<p><code>caches.match(req)</code>将会试图在CacheStorage中匹配请求的url获取值，然后丢给管道同步函数<code>then</code>，传参<code>resp</code>为Cache匹配到的值。</p>
<p>此时管道内将尝试返回resp，如果resp为<code>null</code>或<code>undefined</code>[即获取不到对应的缓存]，将执行fetch操作，fetch成功后将<code>open</code>打开CacheStorage，并<code>put</code>放入缓存。此时如果<code>fetch</code>失败将直接报错，不写入缓存。</p>
<p>在下一次获取同一个URL的时候，缓存匹配到的将不再是空白值，此时<code>fetch</code>不执行，直接返回缓存，大大提升了速度。</p>
<p>由于npm的cdn对于latest缓存并不是持久有效的，所以我们最好还是判断一下url版本中是否以@latest为结尾。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">is_latest</span> = (<span class="params">url</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> url.<span class="title function_">replace</span>(<span class="string">&#x27;https://&#x27;</span>, <span class="string">&#x27;&#x27;</span>).<span class="title function_">split</span>(<span class="string">&#x27;/&#x27;</span>)[<span class="number">1</span>].<span class="title function_">split</span>(<span class="string">&#x27;@&#x27;</span>)[<span class="number">1</span>] === <span class="string">&#x27;latest&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> cache_url_list) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">is_latest</span>(req.<span class="property">url</span>)) &#123; <span class="keyword">return</span> <span class="title function_">fetch</span>(req) &#125;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">url</span>.<span class="title function_">match</span>(cache_url_list[i])) &#123;</span><br><span class="line">        <span class="keyword">return</span> caches.<span class="title function_">match</span>(req).<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">resp</span>) &#123;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="离线化缓存-Cache-For-Offline"><a href="#离线化缓存-Cache-For-Offline" class="headerlink" title="离线化缓存 &#x2F; Cache For Offline"></a>离线化缓存 &#x2F; Cache For Offline</h3><p>对于博客来说，并不是所有内容都是一成不变的。传统PWA采用SW更新同时刷新缓存，这样不够灵活，同时刷新缓存的版本号管理也存在着很大的漏洞，长时间访问极易造成庞大的缓存冗余。因此，对于博客的缓存，我们要保证用户每次获取都是最新的版本，但也要保证用户在离线时能看到最后一个版本的内容。</p>
<p>因此，针对博客来说，策略应该是先获取最新内容，然后更新本地缓存，最后返回最新内容；离线的时候，尝试访问最新内容会回退到缓存，如果缓存也没有，就回退到错误页面。</p>
<p>即：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Online:</span><br><span class="line">发起Request =&gt; 发起fetch =&gt; 更新Cache =&gt; 返回Response</span><br><span class="line">Offline:</span><br><span class="line">发起Request =&gt; 获取Cache =&gt; 返回Response</span><br></pre></td></tr></table></figure>


<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">handle</span> = <span class="keyword">async</span> (<span class="params">req</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">fetch</span>(req.<span class="property">url</span>).<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">res</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!res) &#123; <span class="keyword">throw</span> <span class="string">&#x27;error&#x27;</span> &#125; <span class="comment">//1</span></span><br><span class="line">        <span class="keyword">return</span> caches.<span class="title function_">open</span>(<span class="variable constant_">CACHE_NAME</span>).<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">cache</span>) &#123;</span><br><span class="line">            cache.<span class="title function_">delete</span>(req);</span><br><span class="line">            cache.<span class="title function_">put</span>(req, res.<span class="title function_">clone</span>());</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;).<span class="title function_">catch</span>(<span class="keyword">function</span> (<span class="params">err</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> caches.<span class="title function_">match</span>(req).<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">resp</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> resp || caches.<span class="title function_">match</span>(<span class="keyword">new</span> <span class="title class_">Request</span>(<span class="string">&#x27;/offline.html&#x27;</span>)) <span class="comment">//2</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>if (!res) &#123; throw &#39;error&#39; &#125;</code> 如果没有返回值，直接抛出错误，会被下面的Catch捕获，返回缓存或错误页面</p>
<p><code>return resp || caches.match(new Request(&#39;/offline.html&#39;))</code> 返回缓存获得的内容。如果没有，就返回从缓存中拿到的错误网页。此处offline.html应该在最开始的时候就缓存好</p>
<h2 id="持久化存储-Storage-Persistently"><a href="#持久化存储-Storage-Persistently" class="headerlink" title="持久化存储 &#x2F; Storage Persistently"></a>持久化存储 &#x2F; Storage Persistently</h2><p>由于sw中无<code>window</code>，我们不能使用<code>localStorage</code>和<code>sessionStorage</code>。SW脚本会在所有页面都关闭或重载的时候丢失原先的数据。因此，如果想要使用持久化存储，我们只能使用<code>CacheAPI</code>和<code>IndexdDB</code>。</p>
<h3 id="IndexdDB"><a href="#IndexdDB" class="headerlink" title="IndexdDB"></a>IndexdDB</h3><p>这货结构表类型类似于<code>SQL</code>，能够存储JSON对象和数据内容，但版本更新及其操作非常麻烦，因此本文不对此做过多解释。</p>
<h3 id="CacheAPI"><a href="#CacheAPI" class="headerlink" title="CacheAPI"></a>CacheAPI</h3><p>这东西原本是用来缓存响应，但其本身的特性我们可以将其改造成一个简易的Key&#x2F;Value数据表，可以存储文本&#x2F;二进制，可扩展性远远比IndexdDB要好。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">self.<span class="property">CACHE_NAME</span> = <span class="string">&#x27;SWHelperCache&#x27;</span>;</span><br><span class="line">self.<span class="property">db</span> = &#123;</span><br><span class="line">    <span class="attr">read</span>: <span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            caches.<span class="title function_">match</span>(<span class="keyword">new</span> <span class="title class_">Request</span>(<span class="string">`https://LOCALCACHE/<span class="subst">$&#123;<span class="built_in">encodeURIComponent</span>(key)&#125;</span>`</span>)).<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">res</span>) &#123;</span><br><span class="line">                res.<span class="title function_">text</span>().<span class="title function_">then</span>(<span class="function"><span class="params">text</span> =&gt;</span> <span class="title function_">resolve</span>(text))</span><br><span class="line">            &#125;).<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="title function_">resolve</span>(<span class="literal">null</span>)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">read_arrayBuffer</span>: <span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            caches.<span class="title function_">match</span>(<span class="keyword">new</span> <span class="title class_">Request</span>(<span class="string">`https://LOCALCACHE/<span class="subst">$&#123;<span class="built_in">encodeURIComponent</span>(key)&#125;</span>`</span>)).<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">res</span>) &#123;</span><br><span class="line">                res.<span class="title function_">arrayBuffer</span>().<span class="title function_">then</span>(<span class="function"><span class="params">aB</span> =&gt;</span> <span class="title function_">resolve</span>(aB))</span><br><span class="line">            &#125;).<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="title function_">resolve</span>(<span class="literal">null</span>)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">write</span>: <span class="function">(<span class="params">key, value</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            caches.<span class="title function_">open</span>(<span class="variable constant_">CACHE_NAME</span>).<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">cache</span>) &#123;</span><br><span class="line">                cache.<span class="title function_">put</span>(<span class="keyword">new</span> <span class="title class_">Request</span>(<span class="string">`https://LOCALCACHE/<span class="subst">$&#123;<span class="built_in">encodeURIComponent</span>(key)&#125;</span>`</span>), <span class="keyword">new</span> <span class="title class_">Response</span>(value));</span><br><span class="line">                <span class="title function_">resolve</span>()</span><br><span class="line">            &#125;).<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="title function_">reject</span>()</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用操作：</p>
<p>写入key，value:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> db.<span class="title function_">wtite</span>(key,value)</span><br></pre></td></tr></table></figure>

<p>以文本方式读取key：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> db.<span class="title function_">read</span>(key)</span><br></pre></td></tr></table></figure>

<p>以二进制方式读取key：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> db.<span class="title function_">read_arrayBuffer</span>(key)</span><br></pre></td></tr></table></figure>

<p>其余的blob读取、delete操作此处不过多阐述。</p>
<h2 id="页面与SW通信-Build-Communication-with-Page-and-ServiceWorker"><a href="#页面与SW通信-Build-Communication-with-Page-and-ServiceWorker" class="headerlink" title="页面与SW通信 &#x2F; Build Communication with Page and ServiceWorker"></a>页面与SW通信 &#x2F; Build Communication with Page and ServiceWorker</h2><h3 id="单向连接-Unidirectional-Connect"><a href="#单向连接-Unidirectional-Connect" class="headerlink" title="单向连接 &#x2F; Unidirectional Connect"></a>单向连接 &#x2F; Unidirectional Connect</h3><h3 id="Clients-To-SW"><a href="#Clients-To-SW" class="headerlink" title="Clients To SW"></a>Clients To SW</h3><p>浏览器 &#x3D;&gt; SW</p>
<p>ServiceWorker中有一个非常简单的API<code>postMessage</code>,全路径为<code>navigator.serviceWorker.controller.postMessage</code>.</p>
<p>因此,如果你只是作为页面单方面传递给SW,此api是个不错的选择.</p>
<p>前端写法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> data = <span class="number">123</span></span><br><span class="line">navigator.<span class="property">serviceWorker</span>.<span class="property">controller</span>.<span class="title function_">postMessage</span>(data)</span><br><span class="line"><span class="comment">//发送123</span></span><br></pre></td></tr></table></figure>

<p>SW接收</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">self.<span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(event.<span class="property">data</span>)</span><br><span class="line">  <span class="comment">//输出123</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>此方法可用于单方面向SW提交数据,但无需返回值.比如提示SW可以SkipWaiting,或者提交前端统计数据等等.</p>
<h4 id="SW-To-Clients"><a href="#SW-To-Clients" class="headerlink" title="SW To Clients"></a>SW To Clients</h4><p>首先,Clients必须要从SW中的一个event事件中获取,比如<code>fetch</code>.无法从<code>message</code>事件中获取client.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">addEventListener</span>(<span class="string">&#x27;fetch&#x27;</span>, <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">    event.<span class="title function_">waitUntil</span>(<span class="keyword">async</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!event.<span class="property">clientId</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">const</span> client = <span class="keyword">await</span> clients.<span class="title function_">get</span>(event.<span class="property">clientId</span>);</span><br><span class="line">        <span class="keyword">if</span> (!client) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">const</span> data = <span class="number">123</span>;</span><br><span class="line">        client.<span class="title function_">postMessage</span>(data);</span><br><span class="line">    &#125;());</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="双向通讯-Connect-Each"><a href="#双向通讯-Connect-Each" class="headerlink" title="双向通讯 &#x2F; Connect Each"></a>双向通讯 &#x2F; Connect Each</h3><p>浏览器 &lt;&#x3D;&gt; SW</p>
<p>我们拥有两种方式双向通讯:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Broadcast_Channel_API">Broadcast Channel API</a> 多对多,广播形式.</li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/MessageChannel">Message Channel</a> 一对一</li>
</ol>
<h4 id="MessageChannel"><a href="#MessageChannel" class="headerlink" title="MessageChannel"></a>MessageChannel</h4><p>顾名思义，MessageChannel API 设置了一个可以发送消息的通道。</p>
<p>该实现可以归结为3个步骤。</p>
<p>1.在两侧设置事件侦听器以接收<code>message</code> 事件<br>2.通过发送<code>port</code>并将其存储在SW中，建立与SW的连接。<br>3.使用存储的<code>port</code>回复客户端</p>
<p>前端写法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> messageChannel = <span class="keyword">new</span> <span class="title class_">MessageChannel</span>();</span><br><span class="line">navigator.<span class="property">serviceWorker</span>.<span class="property">controller</span>.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&#x27;INIT&#x27;</span>,<span class="comment">//发送init信息,表示以port2为接收端[即SW的发送端]</span></span><br><span class="line">&#125;, [messageChannel.<span class="property">port2</span>]);</span><br><span class="line">messageChannel.<span class="property">port1</span>.<span class="property">onmessage</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">//监听port1</span></span><br><span class="line">  navigator.<span class="property">serviceWorker</span>.<span class="property">controller</span>.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;PING&#x27;</span><span class="comment">//发送PING</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


<p>SW端写法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">self.<span class="title function_">addEventListener</span>(<span class="string">&quot;message&quot;</span>, <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> data = event.<span class="property">data</span>;</span><br><span class="line">    <span class="keyword">if</span> (!!data) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (data.<span class="property">type</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;INIT&#x27;</span>:</span><br><span class="line">                self.<span class="property">ClientPort</span> = event.<span class="property">ports</span>[<span class="number">0</span>];</span><br><span class="line">            <span class="attr">default</span>:</span><br><span class="line">                self.<span class="property">ClientPort</span>.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">                    <span class="attr">type</span>: <span class="string">&#x27;DATA&#x27;</span>,</span><br><span class="line">                    <span class="attr">data</span>: <span class="string">&#x27;pong&#x27;</span></span><br><span class="line">                &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>然后查看控制台,你就会看到里面一直在乒乒乓乓,说明成功了.</p>
<p>我们简单的改写一下,变成异步形式传输数据:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mCh = &#123;</span><br><span class="line">        <span class="attr">init</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">window</span>.<span class="property">messageChannel</span> = <span class="keyword">new</span> <span class="title class_">MessageChannel</span>();</span><br><span class="line">            navigator.<span class="property">serviceWorker</span>.<span class="property">controller</span>.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&#x27;INIT&#x27;</span>,</span><br><span class="line">            &#125;, [messageChannel.<span class="property">port2</span>]);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">send</span>: <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> uuid = (<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&#x27;xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx&#x27;</span>.<span class="title function_">replace</span>(<span class="regexp">/[xy]/g</span>, <span class="keyword">function</span> (<span class="params">c</span>) &#123;</span><br><span class="line">                        <span class="keyword">var</span> r = <span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">16</span> | <span class="number">0</span>, v = c == <span class="string">&#x27;x&#x27;</span> ? r : (r &amp; <span class="number">0x3</span> | <span class="number">0x8</span>);</span><br><span class="line">                        <span class="keyword">return</span> v.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;)()</span><br><span class="line">                navigator.<span class="property">serviceWorker</span>.<span class="property">controller</span>.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">                    <span class="attr">type</span>: <span class="string">&#x27;DATA&#x27;</span>,</span><br><span class="line">                    <span class="attr">data</span>: data,</span><br><span class="line">                    <span class="attr">id</span>: uuid</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="title function_">reject</span>(&#123;</span><br><span class="line">                        <span class="attr">message</span>: <span class="string">&#x27;timeout&#x27;</span>,</span><br><span class="line">                        <span class="attr">ok</span>: <span class="literal">false</span></span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;, <span class="number">2000</span>);</span><br><span class="line">                messageChannel.<span class="property">port1</span>.<span class="property">onmessage</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (event.<span class="property">data</span>.<span class="property">id</span> === uuid) &#123;</span><br><span class="line">                        <span class="title function_">resolve</span>(&#123;</span><br><span class="line">                            <span class="attr">message</span>: event.<span class="property">data</span>.<span class="property">data</span>,</span><br><span class="line">                            <span class="attr">ok</span>: <span class="literal">true</span></span><br><span class="line">                        &#125;)</span><br><span class="line">                    &#125;;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>由于MessageChannel特性,一个port只要不是连续传输数据就会被断开.所以每次传输时我们要先初始化,后发送数据.</p>
<p>由于传输时无状态的,我们将每一个包都打上特定的uuid,返回包里也写上对应的uuid即可判断那个包是哪个对应的返回值.</p>
<p>SW端也要做一点点相应的改动</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">self.<span class="property">ClientPort</span>.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="attr">id</span>: data.<span class="property">id</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这样,一个兼容性较好的SW双向传输就解决了.</p>
<h4 id="Broadcast-Channel"><a href="#Broadcast-Channel" class="headerlink" title="Broadcast Channel"></a>Broadcast Channel</h4><blockquote>
<p>请注意,BroadCast虽然写法建议,但是对浏览器兼容性要求非常高[Chrome 54,IOS Safari全线不支持].用此api请三思.</p>
</blockquote>
<blockquote>
<p>另外,由于是广播形式,一个页面如果有多个SW,他们会同时收到消息.</p>
</blockquote>
<p>前端</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> broadcast = <span class="keyword">new</span> <span class="title class_">BroadcastChannel</span>(<span class="string">&#x27;Channel Name&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">send_ping</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    broadcast.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;PING&#x27;</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">broadcast.<span class="property">onmessage</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;PONG&#x27;</span>)</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">send_ping</span>()</span><br><span class="line">    &#125;, <span class="number">500</span>);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="title function_">send_ping</span>()</span><br></pre></td></tr></table></figure>

<p>SW端</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> broadcast = <span class="keyword">new</span> <span class="title class_">BroadcastChannel</span>(<span class="string">&#x27;Channel Name&#x27;</span>);</span><br><span class="line">broadcast.<span class="property">onmessage</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">    broadcast.<span class="title function_">postMessage</span>(&#123; <span class="attr">type</span>: <span class="string">&quot;PONG&quot;</span> &#125;)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>只要ChannelName对应,即可在里面顺利传输消息.</p>
<h2 id="细节与注意-Something-Small-But-Need-to-Be-Mentioned"><a href="#细节与注意-Something-Small-But-Need-to-Be-Mentioned" class="headerlink" title="细节与注意 &#x2F; Something Small But Need to Be Mentioned"></a>细节与注意 &#x2F; Something Small But Need to Be Mentioned</h2><h3 id="无法修改的-Header"><a href="#无法修改的-Header" class="headerlink" title="无法修改的 Header"></a>无法修改的 Header</h3><p>由于ServiceWorker本质上仍然属于浏览器,因此,你无法控制例如header中的<code>Host</code>\<code>Refferer</code>\<code>Access-Control-Allow-Origin</code>用于绕过防盗链\CORS\指定host选择ip</p>
<h3 id="难以卸载的-SW"><a href="#难以卸载的-SW" class="headerlink" title="难以卸载的 SW"></a>难以卸载的 SW</h3><p>SW一大特性,一旦被安装,就不能通过传统方式卸载掉.</p>
<p>如果你直接删除<code>sw.js</code>文件并删除安装代码,那么,新用户是不会被安装的,但是原先已经安装过的用户sw会继续劫持这他们的网页,导致老用户网页不更新或者出现异常.</p>
<p>正确的删除方法是将安装代码改成卸载代码:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">navigator.serviceWorker.getRegistrations().then(function(registrations) &#123;</span><br><span class="line"> for(let registration of registrations) &#123;</span><br><span class="line">  registration.unregister()</span><br><span class="line">&#125; &#125;)</span><br></pre></td></tr></table></figure>

<p>并将sw内容改成透明代理,方便没有卸载的用户正常使用.</p>
<h3 id="堵塞整个浏览器的代码"><a href="#堵塞整个浏览器的代码" class="headerlink" title="堵塞整个浏览器的代码"></a>堵塞整个浏览器的代码</h3><p>由于SW运行在DOM上下文,如果在sw中执行一些消耗资源的代码会直接耗尽浏览器资源,与dom不同的是,dom耗资源代码只会堵塞一个线程,另一个线程依旧可以正常工作,而sw一旦堵塞会将整个浏览器堵死.因此sw固然可以更快的计算,但万不可将一些极易死机的代码交给sw处理.</p>
<h1 id="End"><a href="#End" class="headerlink" title="End"></a>End</h1><p>这篇文章结尾的很仓促,毕竟已经快拖了一个月了,也有很多东西没有讲清楚,未来可能会小修小改.</p>
<p>篇幅所限,一些sw其他功能并没有详细讲述,比如后台更新或者推送通知.这些功能在实际开发中并不是特别有用,或者在国内大环境下并不适合.可能这些功能会在下一篇文章,sw的实操中讲述.</p>
<p>停下笔的时候,hexo统计这篇文章已经将近1万字,阅读时间近100分钟.不过我认为这值得,毕竟sw就是这么一个凭借着奇思妙想就能绽放出Spark的事物.唯有独特的创造力才能激发无限可能.</p>
<p>当然,这篇文章讲述的都是些非常基础的东西,那在下一篇文章,我会贴出一个个demo,希望你们能对这些充满着智慧的样例激发你们的灵感.</p>
<p>另外,在祝贺你们,虎年大吉,新年快乐!</p>

    </div>
    
    <div class="divider"></div>
    <div class="container post-prev-next">
        
        <a href="/p/d3c51290.html" class="next">
            <div>
                <div class="text">
                    <p class="label">下一篇</p>
                    <h3 class="title">SpeedUp!使用黑科技为你的网站提速</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/p/c0af86a9.html" class="prev">
            <div>
                <div class="text">
                    <p class="label">上一篇</p>
                    <h3 class="title">为什么是APP而不是网页</>
                </div>
            </div>
        </a>
        
    </div>
    <div class="divider"></div>
    
    <div class="about">
        <h1>关于本文</h1>
        <div class="details">
            <p>由 CyanFalse 撰写, 采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a> 许可协议.</p>
        </div>
        
        <p class="tags text-capitalize">
            
            <a href="/tags/ServiceWorker/" class="tag"><svg t="1689914194799" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1646" id="mx_n_1689914194800" width="14" height="14"><path d="M483.2 790.3L861.4 412c1.7-1.7 2.5-4 2.3-6.3l-25.5-301.4c-0.7-7.8-6.8-13.9-14.6-14.6L522.2 64.3c-2.3-0.2-4.7 0.6-6.3 2.3L137.7 444.8c-3.1 3.1-3.1 8.2 0 11.3l334.2 334.2c3.1 3.2 8.2 3.2 11.3 0z m122.7-533.4c18.7-18.7 49.1-18.7 67.9 0 18.7 18.7 18.7 49.1 0 67.9-18.7 18.7-49.1 18.7-67.9 0-18.7-18.7-18.7-49.1 0-67.9z" p-id="1647" fill="#1296db"></path><path d="M889.7 539.8l-39.6-39.5c-3.1-3.1-8.2-3.1-11.3 0l-362 361.3-237.6-237c-3.1-3.1-8.2-3.1-11.3 0l-39.6 39.5c-3.1 3.1-3.1 8.2 0 11.3l243.2 242.8 39.6 39.5c3.1 3.1 8.2 3.1 11.3 0l407.3-406.6c3.1-3.1 3.1-8.2 0-11.3z" p-id="1648" fill="#1296db"></path></svg>ServiceWorker</a><a href="/tags/黑科技/" class="tag"><svg t="1689914194799" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1646" id="mx_n_1689914194800" width="14" height="14"><path d="M483.2 790.3L861.4 412c1.7-1.7 2.5-4 2.3-6.3l-25.5-301.4c-0.7-7.8-6.8-13.9-14.6-14.6L522.2 64.3c-2.3-0.2-4.7 0.6-6.3 2.3L137.7 444.8c-3.1 3.1-3.1 8.2 0 11.3l334.2 334.2c3.1 3.2 8.2 3.2 11.3 0z m122.7-533.4c18.7-18.7 49.1-18.7 67.9 0 18.7 18.7 18.7 49.1 0 67.9-18.7 18.7-49.1 18.7-67.9 0-18.7-18.7-18.7-49.1 0-67.9z" p-id="1647" fill="#1296db"></path><path d="M889.7 539.8l-39.6-39.5c-3.1-3.1-8.2-3.1-11.3 0l-362 361.3-237.6-237c-3.1-3.1-8.2-3.1-11.3 0l-39.6 39.5c-3.1 3.1-3.1 8.2 0 11.3l243.2 242.8 39.6 39.5c3.1 3.1 8.2 3.1 11.3 0l407.3-406.6c3.1-3.1 3.1-8.2 0-11.3z" p-id="1648" fill="#1296db"></path></svg>黑科技</a><a href="/tags/JSdelivr/" class="tag"><svg t="1689914194799" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1646" id="mx_n_1689914194800" width="14" height="14"><path d="M483.2 790.3L861.4 412c1.7-1.7 2.5-4 2.3-6.3l-25.5-301.4c-0.7-7.8-6.8-13.9-14.6-14.6L522.2 64.3c-2.3-0.2-4.7 0.6-6.3 2.3L137.7 444.8c-3.1 3.1-3.1 8.2 0 11.3l334.2 334.2c3.1 3.2 8.2 3.2 11.3 0z m122.7-533.4c18.7-18.7 49.1-18.7 67.9 0 18.7 18.7 18.7 49.1 0 67.9-18.7 18.7-49.1 18.7-67.9 0-18.7-18.7-18.7-49.1 0-67.9z" p-id="1647" fill="#1296db"></path><path d="M889.7 539.8l-39.6-39.5c-3.1-3.1-8.2-3.1-11.3 0l-362 361.3-237.6-237c-3.1-3.1-8.2-3.1-11.3 0l-39.6 39.5c-3.1 3.1-3.1 8.2 0 11.3l243.2 242.8 39.6 39.5c3.1 3.1 8.2 3.1 11.3 0l407.3-406.6c3.1-3.1 3.1-8.2 0-11.3z" p-id="1648" fill="#1296db"></path></svg>JSdelivr</a>
        </p>
        
    </div>
    

    

    
        <div class="content container about" style="margin:8px auto">
            <div id="Comments">
                <p style="align-items: center;text-align: center;" id="comment_notice">Wait...</p>
            </div>
        </div>
        
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
        </div>
        <span>&copy; 2024
                CyanFalse<br> </span>
                <span>Hexo Powered | NPMMirror CDN Supported</span></br>
                <span>浙ICP备2023021315号-2</span></div>
        

    </div>
</footer>
        <script async src="https://umami.eurekac.cn/script.js" data-website-id="8be37a45-1387-4cd9-86ae-7fd3d33e8c29"></script>
        <script src="https://cdn.eurekac.cn/npm/@chenyfan/cache-db/0.0.4/files/index.js"></script>
        <!-- FancyBox -->
        
        <script src="https://cdn.eurekac.cn/npm/@fancyapps/ui/4.0.31/files/dist/fancybox.umd.js"></script>
        
        <script src='/js/main.js'></script>
        
        
        
        <script src="https://cdn.eurekac.cn/npm/pagemap/1.4.0/files/dist/pagemap.min.js"></script>
        <script src="https://cdn.eurekac.cn/npm/notyf/3.10.0/files/notyf.min.js"></script>
        <script>
            window.notyf = new Notyf({
                duration: 3000,
                position: {
                    x: 'right',
                    y: 'bottom'
                },
                ripple: true,
                dismissible: true
            });
            window.importJS = async (url) => {
                return new Promise((resolve, reject) => {
                    let script = document.createElement('script')
                    script.src = url
                    script.onload = () => {
                        resolve()
                    }
                    script.onerror = () => {
                        reject()
                    }
                    document.head.appendChild(script)
                })

            }
            window.importCSS = async (url) => {
                return new Promise((resolve, reject) => {
                    let link = document.createElement('link')
                    link.rel = 'stylesheet'
                    link.href = url
                    link.onload = () => {
                        resolve()
                    }
                    link.onerror = () => {
                        reject()
                    }
                    document.head.appendChild(link)
                })
            };
            (async () => {
                if (!!document.getElementById("Comments")){
                    const data = JSON.parse((await db.read("CommentSetting")) || JSON.stringify({
                    enable: true,
                    delay: 5
                }))
                if (data.enable) {
                    document.getElementById("comment_notice").innerText = "Comment Will Load After " + data.delay + "s"
                    setTimeout(() => {
                        const wait_comment_load = setInterval(async () => {
                            if (isElementVisible(document.getElementById("Comments"))) {
                                clearInterval(wait_comment_load)
                                document.getElementById("comment_notice").innerText = "Loading Comment Script..."
                                await loadJS("https://cdn.eurekac.cn/npm/artalk/2.8.2/files/dist/Artalk.js")
                                document.getElementById("comment_notice").innerText = "Loading Comment Style..."
                                await loadCSS("https://cdn.eurekac.cn/npm/artalk/2.8.2/files/dist/Artalk.css")
                                document.getElementById("comment_notice").innerText = "Loading Comment Frame..."
                                window.artalk = Artalk.init({
                                    el: '#Comments',
                                    pageKey: window.location.pathname,
                                    pageTitle: "",
                                    server: 'https://artalk.eurekac.cn',
                                    site: 'CyanFalseの幻想乡♂'
                                })
                                artalk.setDarkMode(window.darkMode)
                            }
                        }, 1000)
                    }, data.delay*1000)
                } else {
                    document.getElementById("comment_notice").innerText = "Comment Disabled by Your Config"
                }
                const isElementVisible = (el) => {
                    const rect = el.getBoundingClientRect()
                    const vWidth = window.innerWidth || document.documentElement.clientWidth
                    const vHeight = window.innerHeight || document.documentElement.clientHeight
                    if (
                        rect.right < 0 ||
                        rect.bottom < 0 ||
                        rect.left > vWidth ||
                        rect.top > vHeight
                    ) {
                        return false
                    }

                    return true
                }
                }
                if (!!document.querySelector('#map')) {
                    window.loadPageMap = (dark) => {
                        document.querySelector('#map').id = 'map-predelete'
                        let newMap = document.createElement('canvas')
                        newMap.id = 'map'
                        document.querySelector('#map-predelete').insertAdjacentElement('afterend', newMap)
                        document.querySelector('#map-predelete').remove()
                        let initColor = dark ? '255,255,255' : '0,0,0'
                        pagemap(document.querySelector('#map'), {
                            viewport: null,
                            styles: {
                                'header,footer,section,article': 'rgba(' + initColor + ',0.08)',
                                'h1': 'rgba(' + initColor + ',0.10)',
                                'h2,h3,h4': 'rgba(' + initColor + ',0.08)',
                                'pre': 'rgba(' + initColor + ',0.05)'
                            },
                            back: 'rgba(' + initColor + ',0.02)',
                            view: 'rgba(' + initColor + ',0.05)',
                            drag: 'rgba(' + initColor + ',0.10)',
                            interval: null
                        });
                        document.querySelector('#map').addEventListener('mouseover', () => {
                            document.querySelector('#map').classList.remove('fadeout')
                            document.querySelector('#map').classList.add('fadein')
                        });
                        document.querySelector('#map').addEventListener('mouseout', () => {
                            document.querySelector('#map').classList.remove('fadein')
                            document.querySelector('#map').classList.add('fadeout')
                        });
                        let map = document.querySelector('#map')
                        let mapTimeout = null
                        document.addEventListener('scroll', () => {
                            map.classList.remove('fadeout')
                            map.classList.add('fadein')
                            if (mapTimeout) clearTimeout(mapTimeout)
                            mapTimeout = setTimeout(() => {
                                map.classList.remove('fadein')
                                map.classList.add('fadeout')
                            }, 1000)
                        })
                    }
                    loadPageMap(window.darkMode, true)
                }

                window.db = new CacheDB('CyanAcc', "CyanAccDB")
                if (await db.read('needInstall') === 'never') {
                    console.log('CyanAcc已禁用')
                    return;
                }
                if ('serviceWorker' in navigator) {
                    if (await db.read('install_time') === null ||
                        new Date().getTime() > Number(await db.read('install_time')) + 1000 * 60 * 60 * 4) {
                        await db.write('install_time', new Date().getTime())
                        await db.write('needInstall', 'true')
                    }
                    if (await db.read('needInstall') === 'true') {
                        navigator.serviceWorker.register(`/CyanAcc.js?time=${new Date().getTime()}`)
                            .then(async reg => {
                                let error = 0
                                const CyanAcc_Checker = setInterval(() => {
                                    fetch('/CyanAcc/api', {
                                        method: 'POST',
                                        body: JSON.stringify({
                                            action: 'PING'
                                        })
                                    })
                                        .then(res => res.json())
                                        .then(async res => {
                                            if (res.data === "PONG") {
                                                notyf.success('CyanAcc安装/更新成功<br/>建议刷新以启用CyanAcc！')
                                                clearInterval(CyanAcc_Checker)
                                                await db.write('needInstall', 'false')
                                            }
                                        })
                                        .catch(err => {
                                            console.log(`CyanAcc检查失败，正在重试第${error}次`)
                                            error++
                                            if (error > 10) {
                                                notyf.error({
                                                    message: `CyanAcc安装后无成功响应！将不会再尝试安装！</br>正在卸载已安装的CyanAcc...</br>详细信息请查看控制台`,
                                                    duration: 10000
                                                })
                                                console.error(err)
                                                clearInterval(CyanAcc_Checker)
                                                db.write('needInstall', 'never')
                                                reg.unregister()
                                            }
                                        })
                                }, 1000);
                            }).catch(async err => {
                                notyf.error({
                                    message: `CyanAcc安装失败！</br>将不会再尝试启动CyanAcc</br>请点击右上角设置手动安装</br>详细信息请查看控制台`,
                                    duration: 10000
                                })
                                console.error(err)
                                await db.write('needInstall', 'never')
                            })
                    } else {
                        console.log('CyanAcc暂时无需更新，正在获取脚本与样式注入')
                        await importJS('/CyanAcc/custom.js?time=' + new Date().getTime())
                        console.log('CyanAcc脚本注入成功')
                        await importCSS('/CyanAcc/custom.css?time=' + new Date().getTime())
                        console.log('CyanAcc样式注入成功')
                    }
                } else {
                    if (location.protocol !== 'https:') notyf.error('请使用HTTPS协议以启用CyanAcc')
                    else {
                        notyf.error('您的浏览器不支持或被广告插件禁用ServiceWorker</br>已直接禁用CyanAcc')
                        await db.write('needInstall', 'never')
                    }
                }
            })();
        </script>
        
    </body>
</html>